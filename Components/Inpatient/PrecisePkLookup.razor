@page "/inpatient/precisepk"
@using AutoCAC.Components.Templates.PatientSearch
@using AutoCAC.Models
@inject IDbContextFactory<mainContext> Db
<PageTitle>Precise PK Lookup</PageTitle>
<DataGridVanilla TItem="AutoCAC.Models.PatientLink" GridModel="GridModel" >
	<HeaderContent>
		<PatientDialogButton AfterPatientSelect="OnSelect" />
	</HeaderContent>
	<TrailingColumns>
		<ActionDefaultColumn TItem="AutoCAC.Models.PatientLink" ShowEdit="false" GridModel="GridModel" />
	</TrailingColumns>
</DataGridVanilla>
@code {
	private async Task OnSelect(AutoCAC.Models.Patient patient)
	{
		var patientId = patient.Id;
		var pkPatient = new AutoCAC.Models.PatientLink
			{
				PatientId = patientId
			};
		var exists = await Db.GetFirstValueAsync<Guid?>($"Select LinkID From PatientLink Where PatientID = {patientId}");
		if (exists == null)
		{
			await Db.AddItemAsync(pkPatient);
		}
		await GridModel.SetQuickFilterAsync(patient.ChartNumber);
	}
	private DataGridHelper<AutoCAC.Models.PatientLink> GridModel = new()
	{
		QueryFactory = db => db.PatientLinks
			.Include(x => x.Patient),
		IncludeColumns = new[] { "Patient.Name", "Patient.ChartNumber", "LinkId" },
		SearchColumns = new[] { "Patient.Name", "Patient.ChartNumber", "LinkId" }
	};
}
