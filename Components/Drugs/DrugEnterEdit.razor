@page "/drugenteredit"
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject ContextMenuService ContextMenuService
@inject TooltipService TooltipService
@inject NotificationService NotificationService
@inject IDbContextFactory<mainContext> DbFactory
@using AutoCAC.Components.Templates
@using AutoCAC.Models
@using AutoCAC.Extensions
@using Microsoft.EntityFrameworkCore
@inject AutoCAC.Services.UserContextService UserContext
@implements IDisposable

<PageTitle>Drug Enter Edit</PageTitle>

<AuthorizedGroups Groups=@(new[] { "PharmacistSupervisor" })>
    <NdfLookup SelectionChanged="OnNdfSelected" />
    <hr>
    @if(selectedNdf != null)
    {
        <DrugsTbl SelectionChanged="OnDrugSelected" SelectedNdf="selectedNdf" @ref="DrugsTblRef" />
    }
    else
    {
        <span>Select drug from National Drug Formulary above to continue</span>
    }
    <hr>
    <RPMSOutput />
</AuthorizedGroups>

@code {
    [CascadingParameter(Name = "MainLayout")] public MainLayout Layout { get; set; }
    private string ndcInput = string.Empty;
    private DrugsTbl DrugsTblRef;
    private Ndf selectedNdf;
    private Drug selectedDrug;

    private Task OnNdfSelected(Ndf selected)
    {
        selectedNdf = selected;
        return Task.CompletedTask;
    }

    private async Task OnDrugSelected(Drug selected)
    {
        selectedDrug = selected;
        await JS.DialogShow();
        if (Layout.RPMS.CurrentMode.SignedIn)
        {
            await RunRPMSCommands();
        }
        else
        {
            Layout.RPMS.SubscribeToModeChanged(HandleModeChanged);
        }
        return;
    }

    private async Task RunRPMSCommands()
    {
        if (selectedDrug != null)
        {
            try
            {

                if (selectedDrug.Id == 0)
                {
                    await NewDrug();
                }
                else
                {
                    await NdcChange();
                    await Layout.RPMS.SendAsync(selectedNdf.Ndc);
                    Layout.RPMS.WriteToXterm($"(Dispense unit: {selectedDrug.DispenseUnit}): ");
                }
            }
            finally
            {
                Layout.RPMS.UnSubscribeToModeChanged(HandleModeChanged);
            }
        }
    }

    private async Task NewDrug()
    {
        await Layout.GoToMenu("DRUG");
        await Layout.RPMS.SendAsync(selectedDrug.Name);
        for (int i = 0; i < 20; i++)
        {
            string prompt = Layout.RPMS.CheckPrompt( "Yes//", "No//", "CHOOSE");
            switch(prompt)
            {
                case "No//":
                    await CreateNewDrug();
                    return;
                case "Yes//":
                    string lastStr = Layout.RPMS.Output.Buffered;
                    if(lastStr.Contains("Lookup: GENERIC NAME"))
                    {
                        var parameters = new Dictionary<string, object>
                        {
                            { "SelectedNdf", selectedNdf },
                            { "drug", selectedDrug },
                            { "nullOnCancel", true}
                        };
                        selectedDrug = await DialogService.OpenAsync<DrugForm>($"The name {selectedDrug.Name} already exists", parameters);
                        if (selectedDrug==null)
                        {
                            await DrugsTblRef.ClearSelection();
                            await InvokeAsync(StateHasChanged);
                            return;
                        }
                        await Layout.GoToMenu("DRUG");
                        await Layout.RPMS.SendAsync(selectedDrug.Name);
                    }
                    else
                    {
                        await Layout.RPMS.SendAsync("NO");
                    }
                    break;
                case "CHOOSE":
                    await Layout.RPMS.SendAsync("^");
                    break;
                default:
                    throw new RPMSException();
            }
        }
        throw new RPMSException("Max loops reached");
    }

    private async Task CreateNewDrug()
    {
        try
        {
            await Layout.RPMS.SendAsync("YES");
            await Layout.RPMS.EnterUntil("DRUG MESSAGE");
            await Layout.RPMS.SendAsync(selectedDrug.Message);
            await Layout.RPMS.EnterUntil("DEA, SPECIAL HDLG:");
            await Layout.RPMS.SendAsync(selectedDrug.DeaSpcl);
            Layout.RPMS.CheckPromptAndThrow("DAW CODE:");
            await Layout.RPMS.SendAsync("^ORDER UNIT", selectedDrug.OrderUnit, selectedDrug.DispenseUnit, selectedDrug.DispenseUnitsPerOrderUnit, selectedDrug.NcpdpDispenseUnit, selectedNdf.Ndc);
            Layout.RPMS.CheckPromptAndThrow("PRICE PER ORDER UNIT:");
            await Layout.RPMS.SendAsync(selectedDrug.PricePerOrderUnit);
            await Layout.RPMS.EnterUntil("NATIONAL DRUG file?");
            await Layout.RPMS.SendAsync("YES");
            await Layout.RPMS.PromptLoopAsync(new Dictionary<string, Func<Task<bool>>>
            {
                ["Yes or No"] = async () => { await Layout.RPMS.SendAsync("YES"); return false; },
                ["Is this a match "] = async () => { await Layout.RPMS.SendAsync("YES"); return false; },
                ["Press Return"] = async () => { await Layout.RPMS.SendAsync(); return false; },
                ["Enter RETURN to continue"] = async () => { await Layout.RPMS.SendAsync(); return false; },
                [" edit "] = async () => { return true; },
                ["osages"] = async () => { return true; }
            }, 20);
            await Layout.RPMS.EnterUntil("Enter your choice(s) separated by commas");
            await Layout.RPMS.SendAsync(selectedDrug.ApplicationPackage);
            await Layout.RPMS.PromptLoopAsync(new Dictionary<string, Func<Task<bool>>>
                {
                    ["AN Outpatient Pharmacy ITEM"] = OutpatientPackage,
                    ["AN Unit Dose ITEM"] = UDPackage,
                    ["A Non-VA Med ITEM"] = YesOnly,
                    ["AN IV ITEM"] = YesAndUphat,
                    ["Orderable Item"] = async () => { return true; }
                }, 10);
        }
        catch (Exception ex)
        {
            Layout.HandleError(ex);
        }
        finally
        {
            await Layout.SetLoading(false);
        }
    }

    private async Task<bool> OutpatientPackage()
    {
        await Layout.RPMS.SendAsync("YES");
        await Layout.RPMS.EnterUntil("Enter Yes or No");
        await Layout.RPMS.SendAsync("NO");
        await Layout.RPMS.SendAsync("NO");
        return false;
    }    
    
    private async Task<bool> UDPackage()
    {
        await Layout.RPMS.SendAsync("YES", "^", "^");
        return false;
    }    
    
    private async Task<bool> YesAndUphat()
    {
        await Layout.RPMS.SendAsync("YES", "^");
        return false;
    }

    private async Task<bool> YesOnly()
    {
        await Layout.RPMS.SendAsync("YES");
        return false;
    }

    private async Task NdcChange()
    {
        await Layout.GoToMenu("NDC");
        for (int i = 0; i < 3; i++)
        {
            await Layout.RPMS.SendAsync(selectedDrug.Id.ToString());
            string prompt = Layout.RPMS.CheckPrompt("NDC:", "Select DRUG GENERIC NAME");
            switch(prompt)
            {
                case "NDC:":
                    return;
                case "Select DRUG GENERIC NAME":
                    await Task.Delay(500);
                    await Layout.GoToMenu("NDC");
                    break;
                default:
                    throw new Exception("Unknown Menu location");
            }
        }
        throw new Exception("Drug not found");
    }
    
    private async void HandleModeChanged()
    {
        if (Layout.RPMS.JustSignedIn)
        {
            await RunRPMSCommands();   
        }
    }

    public void Dispose()
    {
        Layout.RPMS.UnSubscribeToModeChanged(HandleModeChanged);
    }
}