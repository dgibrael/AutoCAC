
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject ContextMenuService ContextMenuService
@inject TooltipService TooltipService
@inject NotificationService NotificationService
@using AutoCAC.Models
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<AutoCAC.Models.mainContext> DbFactory
@using AutoCAC.Components.Drugs
<RadzenStack>
    @if (selectedRow != null)
    {
        <RadzenButton Click="ClearSelection" ButtonStyle="ButtonStyle.Base" Variant="Variant.Text" Text="@GetSelectedLabel()"
        Style="text-transform: none" />
    }
    else
    {
        <span>Now select an existing drug to update or click New Drug</span>
        <RadzenRow>
            <RadzenLabel Text="Show only active" Style="margin-left: 0.5rem;" />
            <RadzenCheckBox TValue="bool" @bind-Value="showOnlyActive" Change="OnShowOnlyActiveChanged" />
            <DataGridVanilla @ref="grid0" TItem="AutoCAC.Models.Drug" RowSelect="OnRowSelect" AddButtonClick="AddButtonClick" QueryFactory="@Qry()">
                <RadzenDataGridColumn TItem="AutoCAC.Models.Drug" Property="Id" Title="IEN" Width="100px"/>
                <RadzenDataGridColumn TItem="AutoCAC.Models.Drug" Property="Name" Title="Name" />
                <RadzenDataGridColumn TItem="AutoCAC.Models.Drug" Property="Ndc" Title="Current Ndc" Width="100px" />
                <RadzenDataGridColumn TItem="AutoCAC.Models.Drug" Property="ApplicationPackage" Title="Application Package" />
                <RadzenDataGridColumn TItem="AutoCAC.Models.Drug" Property="DosageForm" Title="Dosage Form" />
                <RadzenDataGridColumn TItem="AutoCAC.Models.Drug" Property="DispenseUnit" Title="Dispense Unit" />
                <RadzenDataGridColumn TItem="AutoCAC.Models.Drug" Property="DispenseUnitsPerOrderUnit" Title="Qty Units Per Order" />
                <RadzenDataGridColumn TItem="AutoCAC.Models.Drug" Property="Message" Title="Message" />
                <RadzenDataGridColumn TItem="AutoCAC.Models.Drug" Property="Strength" Title="Strength" />
                <RadzenDataGridColumn TItem="AutoCAC.Models.Drug" Property="Unit" Title="Unit" />
                <RadzenDataGridColumn TItem="AutoCAC.Models.Drug" Property="PharmacyOrderableItem" Title="Pharmacy Orderable Item" />
                <RadzenDataGridColumn TItem="AutoCAC.Models.Drug" Title="Active" Sortable="false" Filterable="false">
                    <Template Context="drug">
                        @if(drug.InactiveDate == null)
                        {
                            <span>Active</span>
                        }
                        else
                        {
                            <span>Inactive</span>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="AutoCAC.Models.Drug" Property="Nf" Title="Nf">
                </RadzenDataGridColumn>
            </DataGridVanilla>
        </RadzenRow>
    }
</RadzenStack>
    @code {
    [Parameter] public EventCallback<AutoCAC.Models.Drug> SelectionChanged { get; set; }
    protected DataGridVanilla<AutoCAC.Models.Drug> grid0;
    private Drug selectedRow;
    bool showOnlyActive = true;
    [Parameter] public Ndf SelectedNdf { get; set; }

    async Task OnShowOnlyActiveChanged(bool _)
    {
        await grid0.ForceReload(); // This triggers LoadData to re-run with updated filter
    }

    private Func<AutoCAC.Models.mainContext, IQueryable<AutoCAC.Models.Drug>> Qry()
    {        
        return ctx =>
        {
            var q = ctx.Drugs.AsQueryable().Where(d => d.VaPrintName == SelectedNdf.PrintName);
            if (showOnlyActive)
                q = q.Where(d => d.InactiveDate == null);

            return q;
        };
    }

    private async Task OnRowSelect(Drug selected)
    {
        selectedRow = selected;
        await SelectionChanged.InvokeAsync(selected);
        await InvokeAsync(StateHasChanged);
    }

    protected async Task AddButtonClick()
    {
        var parameters = new Dictionary<string, object>
        {
            { "SelectedNdf", SelectedNdf }
        };

        selectedRow = await DialogService.OpenAsync<DrugForm>("New Drug", parameters);
        await SelectionChanged.InvokeAsync(selectedRow);
        await InvokeAsync(StateHasChanged);
    }

    public async Task ClearSelection()
    {
        selectedRow = null;
        await SelectionChanged.InvokeAsync(null);
        await InvokeAsync(StateHasChanged);
    }

    private string GetSelectedLabel()
    {
        if (selectedRow == null) return string.Empty;
        return $"Drug name: {selectedRow.Name}; (click to change)";
    }
}
