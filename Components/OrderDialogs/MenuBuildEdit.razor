@page "/menubuild/{Id:int}"
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject ContextMenuService ContextMenuService
@inject TooltipService TooltipService
@inject NotificationService NotificationService
@inject LoadDataGridService LoadDataGridService
@using AutoCAC.Models
@using Microsoft.EntityFrameworkCore
@using AutoCAC.Extensions
@using AutoCAC.Utilities
@using AutoCAC.Components.OrderDialogs
@using Microsoft.AspNetCore.Components.Web
@inject IDbContextFactory<AutoCAC.Models.mainContext> DbFactory
@inject AutoCAC.Services.UserContextService UserContext
@inject IJSRuntime JS

@if (currentMenu != null)
{
    @* Menu metadata display/edit *@
    @if (!editMode)
    {
        <RadzenButton Text="Edit Menu Attributes" Click="ToggleEditAsync" ButtonStyle="ButtonStyle.Light" Icon="edit" />
        <div class="rz-my-3">
            <p><strong>Display Name:</strong> @currentMenu.DisplayText</p>
            <p><strong>Columns:</strong> @currentMenu.Columns</p>
        </div> 
    }
    else
    {
        <RadzenTemplateForm Data="@currentMenu" TItem="MenuBuildMetum" Submit="@SaveMenuMeta">
            <RadzenRow style="margin-bottom: 1rem">
                <RadzenColumn Size="2">
                    <RadzenLabel Text="Display Name:" />
                </RadzenColumn>
                <RadzenColumn Size="10">
                    <RadzenTextBox @bind-Value="currentMenu.DisplayText" />
                </RadzenColumn>
            </RadzenRow>
            <RadzenRow style="margin-bottom: 1rem">
                <RadzenColumn Size="2">
                    <RadzenLabel Text="Name:" />
                </RadzenColumn>
                <RadzenColumn Size="10">
                    <RadzenTextBox @bind-Value="currentMenu.Name" />
                </RadzenColumn>
            </RadzenRow>
            <RadzenRow style="margin-bottom: 1rem">
                <RadzenColumn Size="2">
                    <RadzenLabel Text="Columns: (RPMS max width guide: 4: 26, 3: 39, 2: 79, 1: 240)"  />
                </RadzenColumn>
                <RadzenColumn Size="10">
                    <RadzenNumeric @bind-Value:get="currentMenu.Columns" @bind-Value:set="OnColumnsChanged" Min="1" Max="4" />
                </RadzenColumn>
            </RadzenRow>
            <RadzenRow style="margin-bottom: 1rem">
                <RadzenButton Click="@OverwriteMenu"
                              Text="@($"Overwrite an existing RPMS Menu{(!string.IsNullOrWhiteSpace(overWritingMenu) ? $" ({overWritingMenu})" : "")}")" />
            </RadzenRow>
            <RadzenButton Text="Save" ButtonType="ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" Icon="save" class="rz-mr-2" />
            <RadzenButton Text="Cancel" Click="ToggleEditAsync" ButtonStyle="ButtonStyle.Light" Icon="cancel" />
        </RadzenTemplateForm>
    }

    <h3>Menu Builder: @currentMenu?.DisplayText</h3>
    <RadzenRow>
        <RadzenButton Text="Copy Existing Menu" Click="@CopyExistingMenu" Icon="copy_all" />
        @if (UserContext.IsInGroupOrSuperuser())
        {
            <RadzenButton Text="Review Changes" Style="text-transform: none;" Icon="grading"
                          ButtonStyle="ButtonStyle.Primary"
                          Click="@(() => NavigationManager.NavigateTo($"/menubuild/{Id}/commit"))" />
            <RPMSOutput @ref="RPMSRef" ButtonLabel="Replace Placeholders">
                @if (newItems.Any(i => i.DisplayOnly == "PLACEHOLDER"))
                {
                    <RadzenRow Style="width: 100%;">
                        <RadzenCarousel ButtonShade="Radzen.Shade.Darker" AllowPaging="false" 
                        Auto="false" Style="width: 100%;">
                            <Items>
                                @foreach (var item in newItems.Where(i => i.DisplayOnly == "PLACEHOLDER"))
                                {
                                    <RadzenCarouselItem>
                                        <RadzenColumn Style="width: 80%;">
                                            <RadzenRow>
                                                <span>@item.DisplayText</span>  
                                            </RadzenRow>
                                            <RadzenRow>
                                                <RadzenTextBox @bind-Value="item.AdditionalDetails"
                                                    Style="width: 100%;"
                                                    Change="@(() => UpdateItem(item))" />
                                            </RadzenRow>
                                        </RadzenColumn>
                                    </RadzenCarouselItem>
                                }   
                            </Items>
                        </RadzenCarousel>
                    </RadzenRow>
                    <RadzenRow>
                        <RadzenButton Text="Transfer from RPMS to DB" Click="@OrderDialogsRpmsToDb" />
                    </RadzenRow>
                }
            </RPMSOutput>
        }
        @if (currentMenu?.RequestStatus!="READY FOR REVIEW")
        {            
            <RadzenButton Text="Mark Ready for Review" Style="text-transform: none;" Icon="check"
                            ButtonStyle="ButtonStyle.Success"
                            Click="@MarkEditComplete" />
        }
        else
        {
            <RadzenButton Text="Mark as Editing" Style="text-transform: none;" Icon="edit"
                          Click="@(async () => await SaveMenuChanges())" />
        }
    </RadzenRow>

    @* Grid with drag-and-drop *@
    <div class="grid" style="display: grid; grid-template-columns: 30px repeat(@currentMenu.Columns, 1fr); gap: 20px;">
        @for (int row = 1; row <= MaxRow; row++)
        {
            var currentRow = row;
            <div class="grid-cell"><span>@currentRow</span></div>
            for (int col = 1; col <= currentMenu.Columns; col++)
            {
                var currentCol = col;
                var newCell = newItems.FirstOrDefault(m => m.RowNum == currentRow && m.ColNum == currentCol);
                <div class="grid-cell"
                        @ondragover:preventDefault
                        @ondragover="OnDragOver"
                        @ondrop="e => OnDrop(e, currentRow, currentCol)"
                        style="border:1px dashed #ccc; padding:5px;">
                    @if (newCell is not null)
                    {
                        <div draggable="true"
                                @ondragstart="e => OnDragStart(e, newCell)"
                                class="draggable-card">
                            <RadzenCard>
                                <RadzenSplitButton AlwaysOpenPopup="true" Size="ButtonSize.Small"
                                                   Variant="Variant.Text"
                                                   Click="@(btn => OnExistingSplitBtnClick(newCell, btn))">
                                    <ButtonContent>
                                        @if(newCell.Item?.Id is not null)
                                        {
                                            <i style="width: 100%; text-transform: none; text-align: left;">@($"{newCell.Mnemonic} {(string.IsNullOrWhiteSpace(newCell.DisplayText) ? newCell.Item?.DisplayText : newCell.DisplayText)}")</i>
                                        }
                                        else
                                        {
                                            switch (newCell.DisplayOnly)
                                            {
                                                case "PLACEHOLDER":
                                                    <span class="rz-color-danger" style="width: 100%; text-transform: none; text-align: left;">@($"***{newCell.DisplayText}")</span>
                                                    break;
                                                case "YES-HEADER":
                                                    <strong style="width: 100%; text-transform: none; text-align: left;">@newCell.DisplayText</strong>
                                                    break;
                                                default:
                                                    <span style="width: 100%; text-transform: none; text-align: left;">@newCell.DisplayText</span>
                                                    break;
                                            }
                                        }
                                    </ButtonContent>
                                    <ChildContent>
                                        <RadzenSplitButtonItem Text="Delete Contents" Value="Delete" Icon="delete" IconColor="@Colors.Danger" />
                                        <RadzenSplitButtonItem Text="Delete Contents AND Cell" Value="DeleteCell" Icon="delete" IconColor="@Colors.Danger" />
                                        <RadzenSplitButtonItem Text="Replace With Header" Value="Header" Icon="text_fields" IconColor="@Colors.Info" />
                                        <RadzenSplitButtonItem Text="Replace With Text" Value="Text" Icon="text_fields" IconColor="@Colors.Info" />
                                        <RadzenSplitButtonItem Text="Replace With Order Dialog" Value="Order Dialog" Icon="prescriptions" IconColor="@Colors.Info" />
                                        <RadzenSplitButtonItem Text="Insert Cell Above" Value="Insert" Icon="add_row_above" IconColor="@Colors.Success" />
                                        <RadzenSplitButtonItem Text="Edit Mnemonic" Value="Mnemonic" Icon="edit_attributes" IconColor="@Colors.Warning" />
                                    </ChildContent>
                                </RadzenSplitButton>
                            </RadzenCard>
                        </div>
                    }
                    else
                    {
                        @* Empty cell – show ADD split button *@
                        <RadzenSplitButton AlwaysOpenPopup="true" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary"
                                            Click="@(btn => OnEmptyBtnClick(currentRow, currentCol, btn))"
                                            Style="width: 100%;" Icon="menu">
                            <RadzenSplitButtonItem Text="Add Header" Value="Header" Icon="text_fields" IconColor="@Colors.Success" />
                            <RadzenSplitButtonItem Text="Add Text" Value="Text" Icon="text_fields" IconColor="@Colors.Success" />
                            <RadzenSplitButtonItem Text="Add Order Dialog" Value="Order Dialog" Icon="prescriptions" IconColor="@Colors.Success" />
                            <RadzenSplitButtonItem Text="Delete Cell" Value="MoveUp" Icon="delete" IconColor="@Colors.Danger" />
                            <RadzenSplitButtonItem Text="Insert Cell Above" Value="Insert" Icon="add_row_above" IconColor="@Colors.Success" />
                        </RadzenSplitButton>
                    }
                </div>
            }
        }
    </div>
}

@code {
    [Parameter] public int Id { get; set; }
    private RPMSOutput RPMSRef;
    private List<MenuBuild> newItems;
    private MenuBuildMetum currentMenu;
    private int additionalRows = 1;
    private bool editMode;
    private MenuBuild dragSourceItem;
    private string overWritingMenu;
    private int MaxRow => (newItems.Any() ? newItems.Max(mb => mb.RowNum) : 1) + additionalRows;

    private int MaxTxtLength => currentMenu?.Columns switch
    {
        4 => 26,
        3 => 39,
        2 => 79,
        _ => 240
    };

    protected override async Task OnInitializedAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        await GetCurrentMenu(db);
        await GetNewItems(db);
        editMode = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task GetCurrentMenu(mainContext db)
    {
        currentMenu = await db.MenuBuildMeta
                .Include(m => m.ExistingMenuNavigation)
                .FirstOrDefaultAsync(o => o.Id == Id);
        overWritingMenu = (currentMenu?.ExistingMenu.NotNullOrZero() == true ) ? 
                            currentMenu.ExistingMenuNavigation.DisplayText
                            .ValueIfNullOrWhitespace(currentMenu.ExistingMenuNavigation.Name) : "";
    }

    private async Task ToggleEditAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        await GetCurrentMenu(db);
        await GetNewItems(db);
        await InvokeAsync(StateHasChanged);
        editMode = !editMode;
    }

    private async Task SaveMenuMeta()
    {
        currentMenu.RequestStatus = "EDITS IN PROGRESS";
        await DbFactory.UpdateItemWithConcurrencyAsync(currentMenu, DialogService);
        await using var db = await DbFactory.CreateDbContextAsync();
        await GetNewItems(db);
        editMode = false;
        await InvokeAsync(StateHasChanged);
    }

    private void AddRow()
    {
        additionalRows++;
        StateHasChanged();
    }

    private async Task MoveItemsAsync(int startRow, int col, int moveRows = -1)
    {
        var affectedItems = await DbFactory.ExecuteSqlAsync($"Update MenuBuild Set RowNum=RowNum+{moveRows} Where RowNum>={startRow} and ColNum={col} and Menu_id={Id}");
        if (affectedItems == 0)
        {
            additionalRows+=moveRows;
        }
        await SaveMenuChanges();
        await InvokeAsync(StateHasChanged);
    }

    private async Task GetNewItems(mainContext db)
    {
        newItems = await db.MenuBuilds
            .Include(mb => mb.Item)
            .Where(mb => mb.MenuId == Id)
            .ToListAsync();
    }

    private async Task SaveMenuChanges(string updateStatus = "EDITS IN PROGRESS")
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        await GetNewItems(db);
        if (!string.IsNullOrWhiteSpace(updateStatus))
        {
            currentMenu.RequestStatus = updateStatus;
            await DbFactory.UpdateItemForceConcurrencyAsync(currentMenu);
            await GetCurrentMenu(db);
        }
    }

    private async Task<string> OpenTextDialog(string dispOnly = "YES-HEADER", string initial = null)
    {
        string txtType = dispOnly == "YES-HEADER" ? "Header" : "Text";
        return await DialogService.TextPromptAsync(txtType, $"Enter {txtType} to Display", initial: initial,
            maxLength: MaxTxtLength, disallowedChars: "-;,=^");
    }

    private async Task OnEmptyBtnClick(int row, int col, RadzenSplitButtonItem btn)
    {
        switch (btn.Value)
        {
            case "Header":
                await TxtItemAdd(row, col);
                break;
            case "Text":
                await TxtItemAdd(row, col, "YES");
                break;
            case "Order Dialog":
                await OrderDialogAdd(row, col);
                break;
            case "MoveUp":
                await MoveItemsAsync(row+1, col);
                break;
            case "Insert":
                await MoveItemsAsync(row, col, 1);
                break;
        }
    }

    private async Task OnExistingSplitBtnClick(MenuBuild item, RadzenSplitButtonItem btn)
    {
        switch (btn.Value)
        {
            case "Header":
                await TxtItemEdit(item);
                break;
            case "Text":
                await TxtItemEdit(item, "YES");
                break;
            case "Order Dialog":
                await OrderDialogEdit(item);
                break;
            case "Delete":
                await DeleteItem(item);
                break;
            case "DeleteCell":
                await DeleteItem(item);
                await MoveItemsAsync(item.RowNum + 1, item.ColNum);
                break;
            case "Insert":
                await MoveItemsAsync(item.RowNum, item.ColNum, 1);
                break;
            case "Mnemonic":
                await EditMnemonic(item);
                break;
        }
    }

    private async Task TxtItemAdd(int row, int col, string dispOnly = "YES-HEADER")
    {
        string dispTxt = await OpenTextDialog(dispOnly);
        if (string.IsNullOrWhiteSpace(dispTxt)) return;
        await AddItem(new MenuBuild
        {
            MenuId = Id,
            DisplayText = dispTxt,
            DisplayOnly = dispOnly,
            RowNum = row,
            ColNum = col
        });
    }

    private async Task OrderDialogAdd(int row, int col)
    {
        var placeholderField = new PlaceholderField
        {
            MaxLength = MaxTxtLength - 3
        };
        var qo = await DialogService.OpenAsync<OrderDialogSelect>(
            "Order Dialog",
            parameters: new Dictionary<string, object> { { "placeholderField", placeholderField } },
            options: new DialogOptions { Width = "75%", Resizable = true });
        if (qo != null)
        {
            if (qo is PlaceholderField ph)
            {
                await AddItem(new MenuBuild
                {
                    MenuId = Id,
                    DisplayText = ph.MenuTxt,
                    DisplayOnly = "PLACEHOLDER",
                    RowNum = row,
                    ColNum = col,
                    AdditionalDetails = ph.ExtendedTxt
                });
            }
            else if (qo is OrderDialog qoDialog)
            {
                await AddItem(new MenuBuild
                {
                    MenuId = Id,
                    ItemId = qoDialog.Id,
                    RowNum = row,
                    ColNum = col
                });
            }
        }
    }

    public async Task AddItem(MenuBuild item)
    {
        await DbFactory.AddItemAsync(item);
        await SaveMenuChanges();
    }

    private async Task TxtItemEdit(MenuBuild item, string dispOnly = "YES-HEADER")
    {
        var curDisp = "";
        if (!string.IsNullOrWhiteSpace(item.DisplayText))
        {
            curDisp = item.DisplayText;
        }
        else if (!string.IsNullOrWhiteSpace(item.Item?.DisplayText))
        {
            curDisp = item.Item?.DisplayText;
        }
        string dispTxt = await OpenTextDialog(dispOnly, curDisp);
        if (string.IsNullOrWhiteSpace(dispTxt)) return;
        item.DisplayText = dispTxt;
        item.DisplayOnly = dispOnly;
        item.AdditionalDetails = null;
        item.ItemId = null;
        item.Item = null;
        await UpdateItem(item);
    }

    private async Task OrderDialogEdit(MenuBuild item)
    {
        PlaceholderField placeholderField = new PlaceholderField
        {
            MaxLength = MaxTxtLength - 3
        };
        if (item.Item != null && item.Item.Id != 0)
        {
            var itmDisp = string.IsNullOrWhiteSpace(item.DisplayText) ? item.Item.DisplayText : item.DisplayText;
            placeholderField.MenuTxt = itmDisp;
            placeholderField.ExtendedTxt = $"{itmDisp} {item.Item.Name}";
        }
        else if (!string.IsNullOrWhiteSpace(item.DisplayOnly))
        {
            placeholderField.MenuTxt = item.DisplayText;
            placeholderField.ExtendedTxt = string.IsNullOrWhiteSpace(item.AdditionalDetails) ? item.DisplayText : item.AdditionalDetails;
        }
        var result = await DialogService.OpenAsync<OrderDialogSelect>(
            item.DisplayText,
            new Dictionary<string, object> { { "SearchText", placeholderField.ExtendedTxt }, { "placeholderField", placeholderField } },
            new DialogOptions { Width = "75%", Resizable = true }
        );
        if (result == null) return;
        item.Item = null;
        if (result is PlaceholderField newText)
        {
            item.DisplayText = newText.MenuTxt;
            item.AdditionalDetails = newText.ExtendedTxt;
            item.ItemId = null;
            item.DisplayOnly = "PLACEHOLDER";
        }
        else if (result is OrderDialog selectedDialog)
        {
            item.DisplayText = null;
            item.ItemId = selectedDialog.Id;
            item.DisplayOnly = null;
        }
        await UpdateItem(item);
    }

    private async Task SaveItemChanges(mainContext db)
    {
        bool success = await db.SaveChangesHandleConcurrencyAsync(NotificationService);
        if (!success)
        {
            await GetNewItems(db);
        }
        else
        {
            await SaveMenuChanges();
        }
        await InvokeAsync(StateHasChanged);
    }


    private async Task UpdateItem(MenuBuild item)
    {
        await DbFactory.UpdateItemAsync(item);
        await SaveMenuChanges();
    }

    public async Task DeleteItem(MenuBuild item)
    {
        await DbFactory.DeleteItemAsync(item);
        await SaveMenuChanges();
    }

    private async Task EditMnemonic(MenuBuild item)
    {
        var result = await DialogService.TextPromptAsync("Edit Mnemonic", "Mnemonic", initial: item.Mnemonic, maxLength: 4);
        if (result == null) return;
        item.Mnemonic = result;
        await UpdateItem(item);
    }

    private async Task OrderDialogsRpmsToDb()
    {
        await RPMSRef.RunUpdateFromRPMS("OrderDialog", async () =>
        {
            await JS.DialogHide();
            foreach (var item in newItems.Where(i => i.DisplayOnly == "PLACEHOLDER").ToList())
            {
                await OrderDialogEdit(item);
            }
        });
    }

    void OnDragStart(DragEventArgs e, MenuBuild cell)
    {
        dragSourceItem = cell;
        e.DataTransfer.EffectAllowed = "move";
    }

    void OnDragOver(DragEventArgs e)
    {
        e.DataTransfer.DropEffect = "move";
    }

    private async Task OnDrop(DragEventArgs e, int targetRow, int targetCol)
    {
        if (dragSourceItem == null) return;
        if (dragSourceItem.RowNum == targetRow && dragSourceItem.ColNum == targetCol) return;

        var commands = new List<FormattableString>();

        // Check if target cell is occupied
        var targetOccupied = newItems.Any(m =>
            m.RowNum == targetRow &&
            m.ColNum == targetCol &&
            m.MenuId == Id);

        if (targetOccupied)
        {
            commands.Add($@"
                UPDATE MenuBuild 
                SET RowNum = RowNum + 1 
                WHERE RowNum >= {targetRow} 
                  AND ColNum = {targetCol} 
                  AND Menu_id = {Id}");
        }

        commands.Add($@"
            UPDATE MenuBuild 
            SET RowNum = {targetRow}, ColNum = {targetCol} 
            WHERE Id = {dragSourceItem.Id}");

        bool isSameCol = targetCol == dragSourceItem.ColNum;
        bool isNextRow = targetRow == dragSourceItem.RowNum + 1;
        bool isBecomingLast = !newItems.Any(m =>
            m.ColNum == dragSourceItem.ColNum &&
            m.RowNum > dragSourceItem.RowNum &&
            m.Id != dragSourceItem.Id);

        if (!(isSameCol && (isNextRow || isBecomingLast)))
        {
            commands.Add($@"
                UPDATE MenuBuild 
                SET RowNum = RowNum - 1 
                WHERE RowNum > {dragSourceItem.RowNum} 
                  AND ColNum = {dragSourceItem.ColNum} 
                  AND Menu_id = {Id}");
        }
        try
        {
            await DbFactory.ExecuteSqlTransactionsAsync(commands);
            await SaveMenuChanges();
        }
        catch (DbUpdateConcurrencyException)
        {
            NotificationService.Notify(NotificationSeverity.Error
                , "Concurrency error", "This menu was modified by another user. Refreshing data");
            await using var db = await DbFactory.CreateDbContextAsync();
            await GetCurrentMenu(db);
            await GetNewItems(db);
        }
        finally
        {
            dragSourceItem = null;
            await InvokeAsync(StateHasChanged);
        }
    }

    public class PlaceholderField
    {
        public string MenuTxt { get; set; }
        public string ExtendedTxt { get; set; }
        public int MaxLength { get; set; }
    }

    private async Task OverwriteMenu()
    {
        AutoCAC.Models.OrderDialog selectedMenu = await DialogService.OpenAsync<MenuSelectExisting>(
            "Order Dialog",
            options: new DialogOptions { Width = "75%", Resizable = true });
        if (selectedMenu is null) return;
        currentMenu.ExistingMenu = selectedMenu.Id;
        await using var db = await DbFactory.CreateDbContextAsync();
        overWritingMenu = await db.OrderDialogs
                            .Where(x => x.Id == selectedMenu.Id)
                            .Select(x => !string.IsNullOrWhiteSpace(x.DisplayText) ? x.DisplayText : x.Name )
                            .FirstOrDefaultAsync();
        StateHasChanged();
    }

    private async Task CopyExistingMenu()
    {
        AutoCAC.Models.OrderDialog selectedMenu = await DialogService.OpenAsync<MenuSelectExisting>(
            "Order Dialog",
            options: new DialogOptions { Width = "75%", Resizable = true });
        if (selectedMenu != null)
        {
            var commands = new List<FormattableString>
            {
                $"DELETE FROM MenuBuild Where Menu_id={Id}",
                $@"Insert Into MenuBuild ([Menu_id], [Item_id], [Mnemonic], [DisplayText], [DisplayOnly], [RowNum], [ColNum])
                                          SELECT {Id} Menu_id ,[OrderDialogID] Item_id, [Mnemonic], [DisplayText], [DisplayOnly], [RowNum], [ColNum]
                                          FROM [main].[dbo].[OrderMenu]
                                          Where id={selectedMenu.Id}"
            };
            try
            {
                await DbFactory.ExecuteSqlTransactionsAsync(commands);
            }
            catch (DbUpdateConcurrencyException)
            {
                NotificationService.Notify(NotificationSeverity.Error
                    , "Concurrency error", "This menu was modified by another user. Refreshing data");
                await using var db = await DbFactory.CreateDbContextAsync();
                await GetCurrentMenu(db);
                await GetNewItems(db);
                await InvokeAsync(StateHasChanged);
                return;

            }
            await SaveMenuChanges();
            currentMenu.Columns = ((byte)newItems.Max(x => x.ColNum));
            var confirmOverwrite = await DialogService.Confirm("Overwrite RPMS Menu", "Would you like this menu to overwrite the existing RPMS menu when complete?");
            if (confirmOverwrite == true)
            {
                currentMenu.ExistingMenu = selectedMenu.Id;
            }
            await SaveMenuMeta();
            additionalRows = 1;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task MarkEditComplete()
    {
        await SaveMenuChanges("READY FOR REVIEW");
        NavigationManager.NavigateTo($"/menubuild/");
    }

    private async Task OnColumnsChanged(byte newValue)
    {
        if (newValue == currentMenu.Columns)
            return;

        if (newValue < currentMenu.Columns)
        {
            currentMenu.Columns = newValue;
            return;
        }
        bool? userCancelled = await DialogService.Confirm(
            "Increasing the column count may cause issues updating the RPMS menu. Continue?",
            "Warning",
            new ConfirmOptions() { OkButtonText = "No (Recommended)", CancelButtonText = "Yes, continue anyway (NOT Recommended)" }
        );

        if (userCancelled == false)
        {
            currentMenu.Columns = newValue;
        }
    }
}
