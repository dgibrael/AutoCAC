@page "/menubuild"
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject ContextMenuService ContextMenuService
@inject TooltipService TooltipService
@inject NotificationService NotificationService
@using AutoCAC.Models
@using Microsoft.EntityFrameworkCore
@using AutoCAC.Extensions
@inject IDbContextFactory<AutoCAC.Models.mainContext> DbFactory
@inject AutoCAC.Services.UserContextService UserContext
@using AutoCAC.Components.Templates.DataGrids
<DataGridVanilla TItem="AutoCAC.Models.MenuBuildMetum" AddButtonClick="AddButtonClick" 
    GridModel="GridModel">
    <HeaderContent>
        <RadzenButton Text="@(showAll ? "Show Mine" : "Show All")" Click="@ToggleShowAll" Icon="visibility" ButtonStyle="ButtonStyle.Base" />
    </HeaderContent>
    <ChildContent>
        <RadzenDataGridColumn TItem="AutoCAC.Models.MenuBuildMetum" Property="DisplayText" Title="Display Name"/>
        <RadzenDataGridColumn TItem="AutoCAC.Models.MenuBuildMetum" Property="RequestStatus" Title="Status" FilterMode="FilterMode.CheckBoxList" />
        <RadzenDataGridColumn TItem="AutoCAC.Models.MenuBuildMetum" Property="CreatedBy" Title="Created By" FilterMode="FilterMode.CheckBoxList" />
        <ActionColumn TItem="AutoCAC.Models.MenuBuildMetum" Context="data">
            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Base" Size="ButtonSize.Small"
                            Click="@(async args => await EditRow(data))" />
            @if (UserContext?.Username == data.CreatedBy || UserContext?.IsInGroupOrSuperuser()==true)
            {
                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                Click="@(async args => await DeleteRow(data))" />
            }

        </ActionColumn>
    </ChildContent>
</DataGridVanilla>
@code {
    private bool showAll { get; set; }
    private DataGridHelper<AutoCAC.Models.MenuBuildMetum> GridModel = new()
    {
        SearchColumns = new[] { "DisplayText" }
    };
    protected override void OnInitialized()
    {
        showAll = UserContext.UserProfile.IsSuperuser;
        GridModel.QueryFactory = ctx =>
        {
            var q = ctx.MenuBuildMeta.AsQueryable();
            if (!showAll)
                q = q.Where(x => x.CreatedBy == UserContext.Username);
            return q;
        };
    }

    private async Task ToggleShowAll()
    {
        showAll = !showAll;
        await GridModel.ReloadAsync();
    }

    protected async Task EditRow(AutoCAC.Models.MenuBuildMetum args)
    {
        NavigationManager.NavigateTo($"menubuild/{args.Id}");
    }

    protected async Task AddButtonClick()
    {
        NavigationManager.NavigateTo("menubuild/new");
    }

    private async Task DeleteRow(AutoCAC.Models.MenuBuildMetum item)
    {
        var confirmDelete = await DialogService.Confirm("Are you sure you want to delete this request?");
        if (confirmDelete != true) return;
        await using var db = await DbFactory.CreateDbContextAsync();
        db.MenuBuildMeta.Remove(item);
        await db.SaveChangesAsync();
        await GridModel.ReloadAsync();
    }
}
