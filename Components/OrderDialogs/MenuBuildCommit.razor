@page "/menubuild/{Id:int}/commit"
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject ContextMenuService ContextMenuService
@inject NotificationService NotificationService
@inject LoadDataGridService LoadDataGridService
@using AutoCAC.Models
@using Microsoft.EntityFrameworkCore
@using AutoCAC.Extensions
@using AutoCAC.Components.OrderDialogs
@inject IDbContextFactory<AutoCAC.Models.mainContext> DbFactory
@inject IJSRuntime JS
@using System.Text
@using System.Text.RegularExpressions;
@{
    var title = $"Review and Commit changes to RPMS for {currentMenu?.DisplayText} ";
    if (notLinked)
    {
        title += "(Not linked to an RPMS Menu)";
    }
    else
    {
        var _menuDisplay = !string.IsNullOrWhiteSpace(currentMenu.ExistingMenuNavigation.DisplayText) ?
                            currentMenu.ExistingMenuNavigation.DisplayText : currentMenu.ExistingMenuNavigation.Name;
        title += $"(Replacing: {_menuDisplay})";
    }
}

<h3>@title</h3>
<RadzenRow>
    <RadzenColumn>
        <RadzenButton 
            Text="Back to Menu Edit"
            ButtonStyle="ButtonStyle.Base"
            Click="@(() => NavigationManager.NavigateTo($"/menubuild/{Id}"))" />
    </RadzenColumn>
    <RadzenColumn>
        <RadzenButton 
            Text="Commit Changes"
            Icon="check"
            ButtonStyle="ButtonStyle.Success"
            Click="@ShowDialogAndRun" />
    </RadzenColumn>
</RadzenRow>
@if (hasIssues)
{
    <RadzenCard Variant="Variant.Outlined">
        <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Start">
            <RadzenText Text="Potential Issues (Click main button to fix all at once, or arrow to fix individually):"/>
            @foreach (var group in problemGroups)
            {
                if (group.Items.Any())
                {
                    <RadzenSplitButton Text="@group.Label"
                                       ButtonStyle="@group.Style"
                                       AlwaysOpenPopup="false"
                                       Click="@(async args =>
                                       {
                                           var id = int.Parse(args?.Value?.ToString() ?? "0");
                                           await group.OnItemClickAsync(id, group);
                                           await GetLists();
                                       })">

                        @foreach (var item in group.Items)
                        {
                            <RadzenSplitButtonItem Text="@group.ItemText(item)"
                                                   Value="@item.Id.ToString()" />
                        }

                    </RadzenSplitButton>
                }
            }

        </RadzenStack>
    </RadzenCard>
}
<hr>
<RadzenPanel AllowCollapse="true" Collapsed="true">
    <HeaderTemplate>Menu Preview</HeaderTemplate>
    <ChildContent>
        <div class="grid" style="display: grid; grid-template-columns: repeat(@maxCol, 1fr); gap: 20px;">
            @for (int row = 1; row <= maxRow; row++)
            {
                var currentRow = row;
                for (int col = 1; col <= maxCol; col++)
                {
                    var currentCol = col;
                    var cell = addLst?.FirstOrDefault(m => m.RowNum == row && m.ColNum == col);
                    <RadzenCard>
                        @switch (cell?.DisplayOnly)
                        {
                            case "PLACEHOLDER":
                                <h3 class="rz-color-danger">
                                    @cell.DisplayText
                                </h3>
                                break;
                            case "YES-HEADER":
                                <strong>@cell.DisplayText</strong>
                                break;
                            case "YES":
                                <span>@cell.DisplayText</span>
                                break;
                            default:
                                if(cell != null)
                                {
                                    var _newcelldisp = string.IsNullOrWhiteSpace(cell.DisplayText) ? $"{cell.Mnemonic} {cell.Item.DisplayText}" : $"{cell.Mnemonic} {cell.DisplayText}";
                                    <i>@_newcelldisp</i>
                                }
                                break;
                        }
                    </RadzenCard>
                }
            }
        </div>
    </ChildContent>
</RadzenPanel>
<RPMSOutput @ref="RPMSRef" />
@code {
    [Parameter] public int Id { get; set; }
    [CascadingParameter(Name = "MainLayout")] public MainLayout Layout { get; set; }
    private RPMSOutput RPMSRef;
    private MenuBuildMetum currentMenu;
    private List<AutoCAC.Models.MenuBuild> addLst;
    private List<ProblemGroup> problemGroups = new();
    private int maxRow = 1;
    private int maxCol = 1;
    private bool hasIssues => problemGroups.Any(x => x.Items.Any());
    private bool notLinked => currentMenu?.ExistingMenuNavigation == null;
    protected override async Task OnInitializedAsync()
    {
        await GetLists();
        await InvokeAsync(StateHasChanged);
    }

    private int MaxTxtLength => currentMenu?.Columns switch
    {
        4 => 26,
        3 => 39,
        2 => 79,
        _ => 240
    };

    private async Task GetLists()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        currentMenu = await db.MenuBuildMeta
                .Include(m => m.ExistingMenuNavigation)
                .Include(x => x.MenuBuilds)
                    .ThenInclude(x => x.Item)
                .FirstOrDefaultAsync(o => o.Id == Id);
        addLst = currentMenu.MenuBuilds
            .OrderBy(mb => mb.ColNum)
            .ThenBy(mb => mb.RowNum)
            .ToList();
        foreach (var mb in addLst)
        {
            if (mb.DisplayOnly is null || mb.DisplayOnly?.Trim().Equals("NO", StringComparison.OrdinalIgnoreCase) == true)
                mb.DisplayOnly = "";
        }
        maxRow = addLst.Max(mb => mb.RowNum);
        maxCol = addLst.Max(mb => mb.ColNum);

        var menuName = currentMenu?.ExistingMenuNavigation?.Name ?? "";

        // Build problemGroups *here*, after addLst is ready
        problemGroups = new List<ProblemGroup>
        {
            // Text Only
            new ProblemGroup
            {
                Label = "Order Dialogs Marked as Text Only",
                Style = ButtonStyle.Danger,
                Items = addLst
                    .Where(x => x.Item != null && x.DisplayOnly != "")
                    .ToList(),
                OnItemClickAsync = OnTextOnlyClickAsync
            },

            // Mismatched Orders (slightly more complex)
            BuildMismatchedOrdersGroup(menuName),

            // Placeholders
            new ProblemGroup
            {
                Label = "Placeholders Not Replaced",
                Style = ButtonStyle.Warning,
                Items = addLst
                    .Where(x => x.DisplayOnly == "PLACEHOLDER")
                    .ToList(),
                OnItemClickAsync = OnPlaceholderOrMismatchClickAsync,
                ItemText = x => $"{x.DisplayText} ({x.AdditionalDetails})"
            },

            // Custom Display Text
            new ProblemGroup
            {
                Label = "Order Dialog with Menu Display Text",
                Style = ButtonStyle.Warning,
                Items = addLst
                    .Where(x => x?.Item?.Id != null &&
                                !string.IsNullOrWhiteSpace(x?.DisplayText))
                    .ToList(),
                OnItemClickAsync = OnDisplayTextClickAsync,
                ItemText = x => $"Menu Display: {x.DisplayText}; Item Display: {x.Item.DisplayText ?? "[empty]"}"
            }
        };
        StateHasChanged();
    }

    private async Task<int?> OverwriteMenu()
    {
        AutoCAC.Models.OrderDialog selectedMenu = await DialogService.OpenAsync<MenuSelectExisting>(
            "Order Dialog",
            options: new DialogOptions { Width = "75%", Resizable = true });
        if (selectedMenu is null) return null;
        currentMenu.ExistingMenu = selectedMenu.Id;
        await DbFactory.UpdateItemAsync(currentMenu);
        await GetLists();
        return selectedMenu.Id;
    }

    private async Task RunMenuUpdate()
    {
        var menuId = currentMenu.ExistingMenu;
        await Layout.GoToMenu("Menu Items Edit");
        await Layout.RPMS.SendAsync($"`{menuId}");
        Layout.RPMS.CheckPromptAndThrow("Select SEQUENCE:");
        List<string> optionlst = await Layout.RPMS.GetOptions();
        optionlst.TrimBetween("Choose from:", "You may enter a new ITEMS", StringComparison.Ordinal, StringComparison.Ordinal);
        optionlst = optionlst
            .Where(s => !string.IsNullOrWhiteSpace(s))
            .Select(s =>
            {
                var normalized = Regex.Replace(s, @"\s+", " ").Trim();
                var match = Regex.Match(normalized, @"\b\d+\.\d+\b");
                var token = match.Success ? match.Value : null;
                return token;
            })
            .Where(s => !string.IsNullOrEmpty(s))
            .ToList();
        foreach(var opt in optionlst)
        {
            Layout.RPMS.CheckPromptAndThrow("Select SEQUENCE:");
            await Layout.RPMS.SendAsync(opt);
            Layout.RPMS.CheckPromptAndThrow("SEQUENCE:");
            await Layout.RPMS.SendAsync("@");
            Layout.RPMS.CheckPromptAndThrow("SEQUENCE?");
            await Layout.RPMS.SendAsync("YES");
        }
        string seq = "";
        string itemid = "";
        string dispTxt = "";
        string dispOnly = "";
        string mnem = "";
        //add each item
        foreach (var a in addLst)
        {
            seq = $"{a.RowNum}.{a.ColNum}";
            itemid = a.ItemId.HasValue && a.ItemId != 0 ? $"`{a.ItemId}" : "";
            dispTxt = !string.IsNullOrWhiteSpace(a.DisplayText) ? a.DisplayText : "";

            if (string.IsNullOrWhiteSpace(a.DisplayOnly))
            {
                dispOnly = "0";
                mnem = !string.IsNullOrWhiteSpace(a.Mnemonic) ? a.Mnemonic : "";
            }
            else
            {
                switch (a.DisplayOnly)
                {
                    case "YES-HEADER":
                        dispOnly = "2";
                        break;
                    case "YES":
                        dispOnly = "1";
                        break;
                    case "PLACEHOLDER":
                        dispOnly = "1";
                        dispTxt = $"***{dispTxt}";
                        break;
                }
                mnem = "";
            }
            Layout.RPMS.CheckPromptAndThrow("Select SEQUENCE:");
            await Layout.RPMS.SendAsync(seq);
            Layout.RPMS.CheckPromptAndThrow("ITEM:");
            await Layout.RPMS.SendAsync(itemid);
            Layout.RPMS.CheckPromptAndThrow("DISPLAY TEXT:");
            await Layout.RPMS.SendAsync(dispTxt);
            Layout.RPMS.CheckPromptAndThrow("DISPLAY ONLY");
            await Layout.RPMS.SendAsync(dispOnly);
            Layout.RPMS.CheckPromptAndThrow("MNEMONIC:");
            await Layout.RPMS.SendAsync(mnem);
        }
        await Layout.RPMS.SendAsync("^");
        await Layout.RPMS.SendAsync("^");
        await using var db = await DbFactory.CreateDbContextAsync();
        await db.SetMenuBuildMetaStatusAsync(Id, "DONE");
    }

    private async Task ShowDialogAndRun()
    {
        var menuId = currentMenu?.ExistingMenuNavigation?.Id;
        if (menuId == null)
        {
            NotificationService.Notify(NotificationSeverity.Info, "Link an existing menu to proceed");
            menuId = await OverwriteMenu();
            if (menuId == null)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Must be linked to existing RPMS menu");
                return;
            }
            currentMenu.ExistingMenu = menuId;
            await DbFactory.UpdateItemAsync(currentMenu);
            await GetLists();
        }
        if (problemGroups.Any(x => x.Style == ButtonStyle.Danger && x.Items.Any()))
        {
            var continueAnyway = await DialogService.ProceedAnyway("There are still severe problems, are you sure you wish to continue?");
            if (!continueAnyway) return;
        }
        await JS.DialogShow();
        await RPMSRef.RunWhenSignedIn(RunMenuUpdate);
    }

    public class ProblemGroup
    {
        public string Label { get; set; }
        public ButtonStyle Style { get; set; } = ButtonStyle.Danger;
        public List<MenuBuild> Items { get; set; } = new();
        // When a child split button item is clicked
        // Passes the MenuBuild.Id (int)
        public Func<int, ProblemGroup, Task> OnItemClickAsync { get; set; } =
            (_, __) => Task.CompletedTask;
        public Func<MenuBuild, string> ItemText { get; set; } = x => $"{x.Item.DisplayText} ({x.Item.Name})";
    }

    private ProblemGroup BuildMismatchedOrdersGroup(string menuName)
    {
        var group = new ProblemGroup
        {
            Label = "Mismatched Orders",
            Style = ButtonStyle.Danger,
            OnItemClickAsync = OnPlaceholderOrMismatchClickAsync
        };

        if (string.IsNullOrWhiteSpace(menuName))
            return group;

        if (menuName.StartsWith("PSO"))
        {
            group.Label = "This outpatient menu contains inpatient med orders";
            group.Items = addLst
                .Where(x =>
                    !string.IsNullOrWhiteSpace(x?.Item?.DisplayGroup) &&
                    x.Item.DisplayGroup.Contains("MEDICATIONS", StringComparison.OrdinalIgnoreCase) &&
                    !x.Item.DisplayGroup.Contains("OUTPATIENT", StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
        else if (menuName.StartsWith("PS"))
        {
            group.Label = "This inpatient menu contains outpatient med orders";
            group.Items = addLst
                .Where(x =>
                    !string.IsNullOrWhiteSpace(x?.Item?.DisplayGroup) &&
                    x.Item.DisplayGroup.Contains("MEDICATIONS", StringComparison.OrdinalIgnoreCase) &&
                    x.Item.DisplayGroup.Contains("OUTPATIENT", StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        return group;
    }

    private async Task OnTextOnlyClickAsync(int id, ProblemGroup group)
    {
        FormattableString qry;
        if (id == 0)
        {
            qry = $@"Update MenuBuild Set DisplayOnly=''
            Where Menu_Id = {currentMenu.Id} and IsNull(Item_Id, 0) != 0";
        }
        else
        {
            qry = $@"Update MenuBuild Set DisplayOnly=''
            Where id = {id}";
        }
        await DbFactory.ExecuteSqlAsync(qry);
        NotificationService.Success("Successfully repaired");
        return;
    }
    private async Task OnPlaceholderOrMismatchClickAsync(int id, ProblemGroup group)
    {
        if (id == 0)
        {
            foreach(var g in group.Items)
            {
                await OrderDialogEdit(g);
            }
        }
        else
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            var item = await db.MenuBuilds
                        .Where(x => x.Id == id)
                        .Include(x => x.Item)
                        .FirstOrDefaultAsync();
            await OrderDialogEdit(item);
        }
    }
    private async Task OnDisplayTextClickAsync(int id, ProblemGroup group)
    {
        FormattableString qry = $"";
        if (id == 0)
        {
            qry = $@"Update MenuBuild Set DisplayText=''
            Where Menu_Id = {currentMenu.Id} and IsNull(Item_Id, 0) != 0";
        }
        else
        {
            qry = $@"Update MenuBuild Set DisplayText=''
            Where id = {id}";
        }
        await DbFactory.ExecuteSqlAsync(qry);
        NotificationService.Success("Successfully repaired");
        return;
    }

    private async Task OrderDialogEdit(MenuBuild item)
    {
        PlaceholderField placeholderField = new PlaceholderField
        {
            MaxLength = MaxTxtLength - 3
        };
        if (item.Item != null && item.Item.Id != 0)
        {
            var itmDisp = string.IsNullOrWhiteSpace(item.DisplayText) ? item.Item.DisplayText : item.DisplayText;
            placeholderField.MenuTxt = itmDisp;
            placeholderField.ExtendedTxt = $"{itmDisp} {item.Item.Name}";
        }
        else if (!string.IsNullOrWhiteSpace(item.DisplayOnly))
        {
            placeholderField.MenuTxt = item.DisplayText;
            placeholderField.ExtendedTxt = string.IsNullOrWhiteSpace(item.AdditionalDetails) ? item.DisplayText : item.AdditionalDetails;
        }
        var result = await DialogService.OpenAsync<OrderDialogSelect>(
            item.DisplayText,
            new Dictionary<string, object> { { "SearchText", placeholderField.ExtendedTxt }, { "placeholderField", placeholderField } },
            new DialogOptions { Width = "75%", Resizable = true }
        );
        if (result == null) return;
        item.Item = null;
        if (result is PlaceholderField newText)
        {
            item.DisplayText = newText.MenuTxt;
            item.AdditionalDetails = newText.ExtendedTxt;
            item.ItemId = null;
            item.DisplayOnly = "PLACEHOLDER";
        }
        else if (result is OrderDialog selectedDialog)
        {
            item.DisplayText = null;
            item.ItemId = selectedDialog.Id;
            item.DisplayOnly = null;
        }
        await DbFactory.UpdateItemAsync(item);
    }

}
