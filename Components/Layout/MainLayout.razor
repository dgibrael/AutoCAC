@inherits LayoutComponentBase
@inject CookieThemeService CookieThemeService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject ContextMenuService ContextMenuService
@inject TooltipService TooltipService
@inject NotificationService NotificationService
@inject DialogService DialogService
@using System.Text
@inject IJSRuntime JS
@inject IDbContextFactory<AutoCAC.Models.mainContext> DbFactory
@inject AutoCAC.Services.UserContextService UserContext
@using AutoCAC.Extensions

<CascadingValue Value="this" Name="MainLayout">
    <RadzenComponents />
</CascadingValue>

<RadzenLayout style="grid-template-areas: 'rz-sidebar rz-header' 'rz-sidebar rz-body';">
    <RadzenHeader>
        <RadzenRow JustifyContent="JustifyContent.Start" AlignItems="AlignItems.Center" Gap="0">
            <RadzenColumn Size="5">
                <RadzenSidebarToggle Click="@SidebarToggleClick"></RadzenSidebarToggle>
            </RadzenColumn>
            <RadzenColumn Size="7">
                <RadzenStack AlignItems="AlignItems.Center" Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem" class="rz-px-2">
                    <RadzenLink Icon="settings" Path="/settings" />
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
    </RadzenHeader>
    <RadzenBody Expanded="@sidebarExpanded" id="mainContent">
        <RadzenRow class="rz-mx-auto content-container">
            <RadzenColumn Size="12">
                <CascadingValue Value="this" Name="MainLayout">
                    <LoadingContent IsLoading="@(_canAccess is null)">
                        @if(_canAccess == true)
                        {
                            @Body
                        }
                        else
                        {
                            <p>Access Denied</p>
                        }
                    </LoadingContent>
                </CascadingValue>
            </RadzenColumn>
        </RadzenRow>
    </RadzenBody>
    <RadzenSidebar @bind-Expanded="@sidebarExpanded" style="z-index: 2">
        <RadzenStack AlignItems="Radzen.AlignItems.Center" class="rz-py-4 rz-py-lg-6" Style="padding: var(--rz-panel-menu-item-padding); border-bottom: var(--rz-panel-menu-item-border);">
            <RadzenImage Path="images/logo.png"  style="width: 48px; height: 48px;" AlternateText="Application logo"></RadzenImage>
            <RadzenText Text="AutoCAC" TextStyle="Radzen.Blazor.TextStyle.Subtitle1" class="rz-mb-0" style="color: var(--rz-sidebar-color);" />
        </RadzenStack>
        <RadzenPanelMenu>
            @if (UserContext.UserProfile != null)
            {
                <RadzenPanelMenuItem Text="Home" Path="" Icon="home" />
                    <RadzenPanelMenuItem Text="Drug Files" Icon="pill">
                        <AuthPanelItem Text="Drug Enter Edit" Path="drugenteredit" />
                        <AuthPanelItem Text="Benchmark Price Post Install" Path="benchmarkprice" />
                        <RadzenPanelMenuItem Text="Drug Table" Path="drugs" />
                </RadzenPanelMenuItem>
                <AuthPanelItem Text="Supervisors" Icon="supervisor_account" Path="supervisor" NavigateOnClick="false">
                    <RadzenPanelMenuItem Text="Night Shift Rotation" Path="supervisor/inpatient/nightshiftrotation" />
                    <RadzenPanelMenuItem Text="Nurse Compound Training" Path="supervisor/inpatient/NurseCompoundTraining" />
                </AuthPanelItem>
                <AuthPanelItem Text="Inpatient" Icon="inpatient" Path="inpatient" NavigateOnClick="false">
                    <RadzenPanelMenuItem Text="Medication Orders" Path="inpatient/medorder" />
                    <RadzenPanelMenuItem Text="ADT" Path="inpatient/adt" />
                    <AuthPanelItem Text="Precise PK Lookup" Path="inpatient/precisepk" />
                </AuthPanelItem>
                <AuthPanelItem Text="Notes" Path="notes" Icon="notes" />
                <AuthPanelItem Text="Menu Requests" Path="menubuild" Icon="dashboard" />
                <AuthPanelItem Path="piverify" Icon="credit_card" Text="Private Insurance Verification"/>
                <RadzenPanelMenuItem Text="Settings" Icon="settings" >
                    <RadzenPanelMenuItem Text="Search Templates" Path="settings/searchtemplates" />
                    <AuthPanelItem Text="admin" Path="settings/admin" NavigateOnClick="false">
                        <RadzenPanelMenuItem Text="Restricted Pages" Path="settings/admin/restrictpages" />
                    </AuthPanelItem>
                </RadzenPanelMenuItem>
            }
            else
            {
                <span>Loading...</span>
            }
        </RadzenPanelMenu>
        <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="0" class="rz-py-4 rz-py-lg-6" Style="padding: var(--rz-panel-menu-item-padding);">
            <RadzenText Text="AutoCAC v1.0.0" TextStyle="Radzen.Blazor.TextStyle.Caption" TagName="Radzen.Blazor.TagName.P" TextAlign="Radzen.TextAlign.Center" />
            <RadzenText Text="Copyright â’¸ 2025" TextStyle="Radzen.Blazor.TextStyle.Caption" class="rz-mb-0" TagName="Radzen.Blazor.TagName.P" TextAlign="Radzen.TextAlign.Center" />
        </RadzenStack>
    </RadzenSidebar>
    @if (isLoading)
    {
        <div class="rz-dialog-wrapper" style="pointer-events: none;">
            <RadzenCard class="rz-dialog" style="min-height: 0; pointer-events: auto;">
                <RadzenRow>
                    <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                    <RadzenText Text="Loading..." TextStyle="TextStyle.DisplayH5"/>
                </RadzenRow>
            </RadzenCard>
        </div>
    }
</RadzenLayout>
    @code {
    bool sidebarExpanded = true;    
    private bool? _canAccess;
    private bool initialLoad = true;
    protected override async Task OnParametersSetAsync()
    {
        if (initialLoad) return;
        await RunOnNav();
    }

    void SidebarToggleClick()
    {
        sidebarExpanded = !sidebarExpanded;
    }

    [Inject] public RPMSService RPMS { get; set; }

    public bool isLoading { get; private set; }

    public async Task SetLoading(bool value)
    {
        if (isLoading == value)
            return;
        isLoading = value;
        await Task.Yield();
        await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RunOnNav();
            TerminalInterop.RPMS = RPMS;
            StateHasChanged();
        }
        else
        {
            initialLoad = false;
        }
    }

    private async Task RunOnNav()
    {
        Console.WriteLine("run on nav");
        _canAccess = null;
        await UserContext.EnsureInitializedAsync();
        await UserContext.LoadAllowedPages();
        _canAccess = UserContext.CanAccess(NavigationManager.GetRelativeUrl());
    }

    public void HandleError(Exception ex, bool reThrow = false)
    {
        if (ex == null) return;

        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Error,
            Summary = ex.GetType().Name, // "Exception"
            Detail = ex.Message,         // "Could not connect to RPMS."
            Duration = 4000
        });
        _ = InvokeAsync(StateHasChanged);
        if (reThrow)
        {
            throw ex;
        }
    }

    public async Task GoToMenu(string menu = null, int attempts = 30)
    {
        try
        {
            await RPMS.GoToMenu(menu, attempts);
        }
        catch (Exception ex)
        {
            HandleError(ex);
        }
    }

    public async Task ScrollTo(string elementId = "bottom")
    {
        await InvokeAsync(StateHasChanged); // request a UI render
        await Task.Yield();
        if (elementId == "bottom")
        {
            await JS.InvokeVoidAsync("scrollToBottom");
        }
        else if (elementId == "top")
        {
            await JS.InvokeVoidAsync("scrollToTop");
        }
        else
        {
            await JS.InvokeVoidAsync("scrollToElement", elementId);
        }
    }

    public async Task DownloadText(string content, string fileName = "data.txt", string mimeType = "text/plain")
    {
        await JS.InvokeVoidAsync("downloadTextFile", content, fileName, mimeType);
    }


    /// <summary>
    /// Runs a block of RPMS or app commands with loading UI and error handling.
    /// </summary>
    public async Task RunCommands(Func<Task> action)
    {
        await SetLoading(true);

        try
        {
            await action();
        }
        catch (Exception ex)
        {
            HandleError(ex);
        }
        finally
        {
            await SetLoading(false);
        }
    }

    /// <summary>
    /// Runs a block of RPMS or app commands with loading UI and error handling.
    /// </summary>
    public async Task<T> RunCommands<T>(Func<Task<T>> action)
    {
        await SetLoading(true);

        try
        {
            return await action();
        }
        catch (Exception ex)
        {
            HandleError(ex);
            return default!;
        }
        finally
        {
            await SetLoading(false);
        }
    }

    public async Task HandlePrompt(
        List<(string Prompt, Func<Task> Action)> promptActions,
        Func<Task> onNoMatch = null,
        StringComparison comparison = StringComparison.Ordinal)
    {
        string prompt = RPMS.Output.Prompt();
        foreach (var (expectedPrompt, action) in promptActions)
        {
            if (prompt.Contains(expectedPrompt, comparison))
            {
                await action();
                return;
            }
        }

        if (onNoMatch is not null)
        {
            await onNoMatch();
        }
        else
        {
            HandleError(new RPMSException());
        }
    }
}
