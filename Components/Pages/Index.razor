@page "/A"
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject ContextMenuService ContextMenuService
@inject TooltipService TooltipService
@inject NotificationService NotificationService
@using AutoCAC.Components.Templates
@using AutoCAC.Extensions
@using static RPMSService

<PageTitle>Index</PageTitle>
<RPMSOutput OnLoginSuccess="AfterLogin" OnModeChanged="OnModeChanged" />
<DynamicDataGrid TItem="IDictionary<string, object>" Data="ParsedData"/>

@code {
    [CascadingParameter(Name = "MainLayout")] public MainLayout Layout { get; set; }
    private IEnumerable<IDictionary<string, object>> ParsedData;
    private async Task AfterLogin()
    {
        await Layout.GoToMenu();
    }
    private async Task DownloadReport()
    {
        string parsedJson = await Layout.RPMS.GetReportAsync();
        parsedJson = parsedJson.JsonStrFromReport();
        ParsedData = parsedJson.JsonStrToObject<IDictionary<string, object>>();
    }
    private async void OnModeChanged()
    {
        if (Layout.RPMS.IsInMode(RPMSService.Modes.ReportPrompt))
        {
            await DownloadReport();
            await InvokeAsync(StateHasChanged);
        }
    }
}

