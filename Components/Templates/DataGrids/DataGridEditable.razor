@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IDbContextFactory<AutoCAC.Models.mainContext> DbFactory
@inject NavigationManager Nav
@using System.Reflection
@using System.Linq.Expressions
@typeparam TItem where TItem : class, new()
@using Microsoft.AspNetCore.Components.Routing

@if (ConfirmIfUnsubmitted && currentlyEditing != null)
{
    <NavigationLock OnBeforeInternalNavigation="ConfirmLeave" ConfirmExternalNavigation="true" />
}
<DataGridVanilla TItem="TItem"
                 @ref="basegrid"
                 GridModel="GridModel"
                 AddButtonClick="@(DefaultAddButton ? OnAddClick : null)" RowDoubleClick="OnRowDoubleClick"
                 RowEdit="EditRow"
                 ExpandContentView="@ExpandContentView" ExpandContentEdit="@ExpandContentEdit"
                 HeaderContent="@HeaderContent"
                 ExpandContentBoth="@ExpandContentBoth">
    <ChildContent>
        @ChildContent

        <RadzenDataGridColumn TItem="TItem" Width="180px" Frozen="true" FrozenPosition="FrozenColumnPosition.Right">
            <HeaderTemplate>
                <RadzenIcon Icon="settings" />
            </HeaderTemplate>
            <EditTemplate Context="item">
                @if (RowButtonsEditMode is not null)
                {
                    @RowButtonsEditMode(item)
                }
                @if (DefaultRowButtonsEditMode)
                {
                    <RadzenButton Icon="check" Variant="Variant.Flat" Click="@(() => SaveRowAsync(item))" />
                    <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Click="@(() => CancelRow(item))" />
                }
            </EditTemplate>
            <Template Context="item">
                @if (RowButtonsViewMode is not null)
                {
                    @RowButtonsViewMode(item)
                }
                @if (DefaultRowButtonsViewMode)
                {
                    <RadzenButton Icon="edit" Variant="Variant.Flat" ButtonType="ButtonType.Submit" 
                    Disabled="@(DisableEditPredicate?.Invoke(item) ?? false)"
                    Click="@(() => EditBtnClick(item))" />
                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Flat" 
                        Disabled="@(DisableDeletePredicate?.Invoke(item) ?? false)"
                        Click="@(() => DeleteRowAsync(item))" />
                }
            </Template>
        </RadzenDataGridColumn>
    </ChildContent>
</DataGridVanilla>

@code {
    [Parameter] public DataGridHelper<TItem> GridModel { get; set; } = new();
    [Parameter] public RenderFragment ChildContent { get; set; }
    [Parameter] public RenderFragment<TItem> RowButtonsEditMode { get; set; }
    [Parameter] public RenderFragment<TItem> RowButtonsViewMode { get; set; }
    [Parameter] public RenderFragment<TItem> ExpandContentView { get; set; }
    [Parameter] public RenderFragment<TItem> ExpandContentEdit { get; set; }
    [Parameter] public RenderFragment<TItem> ExpandContentBoth { get; set; }
    [Parameter] public RenderFragment HeaderContent { get; set; }
    [Parameter] public Func<TItem, bool> DisableDeletePredicate { get; set; }
    [Parameter] public Func<TItem, bool> DisableEditPredicate { get; set; }
    [Parameter] public bool DefaultRowButtonsViewMode { get; set; } = true;
    [Parameter] public bool DefaultRowButtonsEditMode { get; set; } = true;
    [Parameter] public bool DefaultAddButton { get; set; } = true;
    [Parameter] public Func<Task<TItem>> AddAction { get; set; }
    [Parameter] public bool ConfirmIfUnsubmitted { get; set; } = true;
    [Parameter] public TItem InsertAfterItem { get; set; }
    TItem currentlyEditing = null;
    private async Task OnRowDoubleClick(DataGridRowMouseEventArgs<TItem> args)
    {
        if (!basegrid.Grid.IsRowInEditMode(args.Data))
        {
            await EditBtnClick(args.Data);
        }
    }

    public DataGridVanilla<TItem> basegrid;
    private readonly HashSet<TItem> _newItems = new();

    public async Task OnAddClick()
    {
        await GridModel.SetQuickFilterAsync();

        TItem newItem;

        if (currentlyEditing != null)
        {
            var save = await DialogService
            .YesNoDialog("You have unsaved changes for another item. Would you like to save or discard changes?"
                         , okText: "Save", cancelText: "Discard");
            if (save == true)
            {
                await SaveRowAsync(currentlyEditing, leaveEdit: false);
            }
            basegrid.Grid.CancelEditRow(currentlyEditing);
            currentlyEditing = null;
            await basegrid.Grid.Reload();
        }

        if (AddAction is not null)
        {
            newItem = await AddAction.Invoke();
            if (newItem is null) return; // caller handled it (dialog, etc.)
        }
        else
        {
            newItem = new TItem();
        }

        _newItems.Add(newItem);

        // 🔍 Special case: grid is logically empty
        var isEmpty =
            (GridModel.Count == 0) ||
            (GridModel.Data == null || !GridModel.Data.Any());

        if (isEmpty)
        {
            // Build a new data source with just the new item
            var list = new List<TItem> { newItem };

            GridModel.Data = list;
            GridModel.Count = 1;

            // Ensure we're on the first page and render that single-row page
            // (GoToPage(0) if you have it, otherwise just Reload)
            await basegrid.Grid.FirstPage();  // if available in your wrapper

            // Put the newly added row into edit mode
            await basegrid.Grid.EditRow(newItem);
        }
        else
        {
            if (InsertAfterItem != null)
            {
                await basegrid.Grid.InsertAfterRow(newItem, InsertAfterItem);
            }
            else
            {
                await basegrid.Grid.InsertRow(newItem);
            }
        }
    }

    public void ResetCurrentlyEditing(TItem item)
    {
        if (currentlyEditing != item) return;
        currentlyEditing = null;
    }
    public async Task EditRow(TItem item)
    {
        if (currentlyEditing != null)
        {
            if (currentlyEditing == item) return;
            var save = await DialogService
            .YesNoDialog("You have unsaved changes for another item. Would you like to save or discard changes?"
                         ,okText: "Save", cancelText: "Discard");
            if (save != true)
            {
                currentlyEditing = null;
                await basegrid.Grid.Reload();
                return;
            }
            await SaveRowAsync(currentlyEditing, leaveEdit: false);
            basegrid.Grid.CancelEditRow(currentlyEditing);
        }
        currentlyEditing = item;
        if ((ExpandContentEdit != null || ExpandContentBoth != null) && !basegrid.Grid.IsRowExpanded(item))
        {
            await basegrid.Grid.ExpandRow(item);
        }
    }

    public async Task EditBtnClick(TItem item)
    {
        await basegrid.Grid.EditRow(item);
    }

    public void CancelRow(TItem item)
    {
        basegrid.Grid.CancelEditRow(item);
        if (_newItems.Remove(item))
        {
            GridModel.Reload();
        }
        else
        {
            basegrid.Grid.Reload();
        }
        ResetCurrentlyEditing(item);
    }

    public async Task SaveRowAsync(TItem item, bool leaveEdit = true)
    {
        try
        {
            if (_newItems.Contains(item))
            {
                await DbFactory.AddItemAsync(item);
                _newItems.Remove(item);
            }
            else
            {
                await DbFactory.UpdateItemAsync(item);
            }
            Notify(NotificationSeverity.Success, "Saved", "Changes successfully saved.");
            if (leaveEdit)
            {
                ResetCurrentlyEditing(item);
                basegrid.Grid.CancelEditRow(item);
                await basegrid.Grid.Reload();
            }
        }
        catch (Exception ex)
        {
            Notify(NotificationSeverity.Error, "Save failed", ex.Message);
        }
    }

    public async Task DeleteRowAsync(TItem item)
    {
        ResetCurrentlyEditing(item);
        var ok = await DialogService.Confirm("Delete this item?", "Confirm Delete");
        if (ok != true) return;
        await DbFactory.DeleteItemAsync(item);
        Notify(NotificationSeverity.Success, "Deleted", "Item removed.");
        await GridModel.ReloadAsync();
    }

    private void Notify(NotificationSeverity severity, string summary, string detail)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = severity,
            Summary = summary,
            Detail = detail,
            Duration = 4000
        });
    }

    private async Task ConfirmLeave(LocationChangingContext context)
    {
        if (currentlyEditing == null) return;

        // Stop navigation while we ask
        context.PreventNavigation();

        var save = await DialogService.YesNoDialog(
            "You have unsaved changes, would you like to save or discard?",
            "Unsaved Changes",
            "Save",
            "Discard");

        if (save == true)
        {
            await SaveRowAsync(currentlyEditing, leaveEdit: false);
        }
        currentlyEditing = null;

        // Continue navigation after handling
        Nav.NavigateTo(context.TargetLocation);
    }
}
