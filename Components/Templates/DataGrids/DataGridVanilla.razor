@typeparam TItem where TItem : class
@implements IDisposable

@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject ContextMenuService ContextMenuService
@inject TooltipService TooltipService
@inject NotificationService NotificationService
@inject AutoCAC.Services.UserContextService UserContext
@inject IDbContextFactory<AutoCAC.Models.mainContext> DbFactory

@using AutoCAC.Models
@using Microsoft.EntityFrameworkCore
@using AutoCAC
@using AutoCAC.Extensions
@using System.Text.Json
@using System.Reflection
@using AutoCAC.Components.Templates

<LoadingContent IsLoading="@(GridModel?.IsInitialized != true)">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start"
    Wrap="FlexWrap.Wrap">
        @HeaderContent
        @if (!string.IsNullOrEmpty(GridModel?.AddButtonUrl) || AddButtonClick.HasDelegate)
        {
            <RadzenButton Icon="add_circle_outline"
                          Text="Add"
                          ButtonStyle="ButtonStyle.Success"
                          Click="@OnAddClickInternal"
                          Variant="Variant.Flat" />
        }

        <RadzenButton Text="Download" Click="@DownloadTbl" Icon="download" />

        <RadzenSplitButton Text="Save Template" Icon="save"
                           Click="@(item => SaveGridSettingsClick(item))"
                           ButtonStyle="ButtonStyle.Base">
            <RadzenSplitButtonItem Text="Save Template" Value="private" Icon="account_circle" />
            <RadzenSplitButtonItem Text="Save Public Template" Value="public" Icon="public" />
        </RadzenSplitButton>

        <SearchTemplateDropown DataGridName="@GridModel.PageName" @ref="templateDropdown"
                               SelectedTemplateChanged="OnTemplatePicked" InitialValue="GridModel.InitialTemplate"
                               Placeholder="Load Saved Template..." />
        @if (GridModel?.SearchColumns != null)
        {
            <RadzenColumn Size="4">
                <QuickSearch @bind-Value="GridModel.SearchText" @bind-Value:after="GridModel.ReloadAsync" />
            </RadzenColumn>
        }
    </RadzenStack>

    <RadzenDataGrid @ref="Grid"
                    @bind-Settings="GridModel.Settings"
                    Data="GridModel.Data"
                    Count="GridModel.Count"
                    LoadData="LoadData"
                    LoadColumnFilterData="GridModel.LoadColumnFilterDataAsync"
                    TItem="TItem"
                    IsLoading="IsLoading"
                    AllowFiltering="GridModel.AllowFiltering"
                    AllowPaging="true"
                    PageSize="@PageSize"
                    AllowSorting="GridModel.AllowSorting"
                    AllowColumnResize="true"
                    AllowColumnReorder="GridModel.AllowColumnReorder"
                    AllowGrouping="GridModel.AllowGrouping"
                    AllowColumnPicking="GridModel.AllowColumnPicking"
                    AllowCompositeDataCells="true"
                    ShowPagingSummary="true"
                    CellRender="CellRender"
                    ColumnWidth="200px"
                    AllGroupsExpanded="false"
                    PageSizeOptions="pageSizes"
                    Group="OnGroup"
                    RowEdit="RowEdit"
                    RowDoubleClick="RowDoubleClick"
                    RowSelect="RowSelect" RowExpand="RowExpand"
                    ExpandMode="DataGridExpandMode.Single"
                    ShowExpandColumn="@(ExpandContentView!=null || ExpandContentEdit!=null || ExpandContentBoth!=null)"
                    Context="row"
                    EmptyTemplate="EmptyTemplate"
                    >
        <GroupHeaderTemplate Context="group">
            @if (GroupHeaderCustom is not null)
            {
                @GroupHeaderCustom(group)
            }
            else
            {
                @($"{group.Data.Key}: {group.Data.Count}")
                ;
            }
        </GroupHeaderTemplate>

        <Columns>
            @LeadingColumns?.Invoke(row)

            @if (GridModel.ActionColumnDefault)
            {
                <ActionDefaultColumn Grid="Grid" Context="x" />
            }

            @if (ChildContent is not null)
            {
                @ChildContent
            }
            else if (GridModel.IncludeColumns is not null && GridModel.IncludeColumns.Any())
            {
                @foreach (var col in GridModel.IncludeColumns)
                {
                    <RadzenDataGridColumn TItem="TItem" Property="@col" Title="@col" />
                }
            }
            else
            {
                var props = typeof(TItem)
                .GetProperties(BindingFlags.Public | BindingFlags.Instance)
                .Where(p => !(GridModel.ExcludeColumns ?? Array.Empty<string>())
                .Contains(p.Name, StringComparer.OrdinalIgnoreCase));

                @foreach (var prop in props)
                {
                    <RadzenDataGridColumn TItem="TItem" Property="@prop.Name" Title="@prop.Name" />
                }
            }

            @TrailingColumns?.Invoke(row)
        </Columns>

        <Template Context="item">
            @ExpandContentView?.Invoke(item)
            @ExpandContentBoth?.Invoke(item)
        </Template>

        <EditTemplate Context="item">
            @ExpandContentEdit?.Invoke(item)
            @ExpandContentBoth?.Invoke(item)
        </EditTemplate>
    </RadzenDataGrid>
</LoadingContent>

@code {
    // NEW: caller passes this, or we default to new()
    [Parameter] public DataGridHelper<TItem> GridModel { get; set; } = new();

    // RenderFragments stay as parameters (as requested)
    [Parameter] public RenderFragment ChildContent { get; set; }
    [Parameter] public RenderFragment EmptyTemplate { get; set; }
    [Parameter] public RenderFragment<TItem> ExpandContentView { get; set; }
    [Parameter] public RenderFragment<TItem> ExpandContentEdit { get; set; }
    [Parameter] public RenderFragment<TItem> ExpandContentBoth { get; set; }
    [Parameter] public RenderFragment<TItem> LeadingColumns { get; set; }
    [Parameter] public RenderFragment<TItem> TrailingColumns { get; set; }
    [Parameter] public RenderFragment<Group> GroupHeaderCustom { get; set; }
    [Parameter] public RenderFragment HeaderContent { get; set; }
    [Parameter] public EventCallback AddButtonClick { get; set; }
    [Parameter] public EventCallback<TItem> RowSelect { get; set; }
    [Parameter] public EventCallback<TItem> RowExpand { get; set; }
    [Parameter] public EventCallback<DataGridRowMouseEventArgs<TItem>> RowDoubleClick { get; set; }
    [Parameter] public EventCallback<TItem> RowEdit { get; set; }
    [Parameter] public Action<DataGridCellRenderEventArgs<TItem>> CellRender { get; set; }
    private int[] pageSizes = { 5, 10, 20, 30, 50 };
    int PageSize;
    int OriginalPageSize;

    private bool IsLoading;

    public RadzenDataGrid<TItem> Grid;
    public SearchTemplateDropown templateDropdown;
    private TItem row;

    protected override void OnInitialized()
    {
        // Keep existing behavior, just sourced from Helper now
        if (GridModel.AddButtonDefault &&
            string.IsNullOrEmpty(GridModel.AddButtonUrl) &&
            !AddButtonClick.HasDelegate)
        {
            GridModel.AddButtonUrl = NavigationManager.GetPath("new");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var height = await JSRuntime.GetWindowHeight();

        if (height < 800)
            PageSize = 5;      // small screens
        else if (height < 1200)
            PageSize = 10;     // medium
        else
            PageSize = 20;     // large

        OriginalPageSize = PageSize;

        // NEW: Initialize wires db/user + reload callback
        GridModel.Initialize(
            DbFactory,
            UserContext.Username,
            reloadAsync: () => InvokeAsync(() => Grid.FirstPage(true))
        );

        StateHasChanged();
    }

    public void Dispose()
    {
        // avoid Helper holding a reference to this component via reload callback
        GridModel?.DetachReloadHandler();
    }

    public async Task LoadData(LoadDataArgs args)
    {
        IsLoading = true;
        try
        {
            await GridModel.LoadAsync(args);
        }
        catch (Exception ex)
        {
            await DialogService.Alert(ex.Message, "Load Error");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    public async Task DownloadTbl()
    {
        try
        {
            await GridModel.DownloadCsvAsync(JSRuntime);
        }
        catch (Exception ex)
        {
            await DialogService.Alert(ex.Message, "Download Error");
        }
    }

    private async Task OnAddClickInternal()
    {
        if (AddButtonClick.HasDelegate)
            await AddButtonClick.InvokeAsync(null);
        else if (!string.IsNullOrEmpty(GridModel.AddButtonUrl))
            NavigationManager.NavigateTo(GridModel.AddButtonUrl);
    }

    public async Task OnTemplatePicked(DataGridTemplate tmpl)
    {
        GridModel.LoadedTemplate = tmpl;
        GridModel.Settings = string.IsNullOrWhiteSpace(tmpl?.DataGridSettings)
            ? null
            : JsonSerializer.Deserialize<DataGridSettings>(tmpl.DataGridSettings);

        await Grid.ReloadSettings();
    }

    public async Task SaveGridSettingsClick(RadzenSplitButtonItem item)
    {
        var isPublic = GridModel.LoadedTemplate?.IsShared == true;

        // Override default if the user explicitly selected a value
        if (item?.Value != null)
        {
            var value = item.Value.ToString();
            if (string.Equals(value, "public", StringComparison.OrdinalIgnoreCase))
                isPublic = true;
            else if (string.Equals(value, "private", StringComparison.OrdinalIgnoreCase))
                isPublic = false;
        }

        var templates = await GridModel.GetTemplatesAsync();
        var templateNames = templates.Select(x => x.TemplateName);

        var templateName = await DialogService.AutoCompleteDialogAsync(
            GridModel.LoadedTemplate?.TemplateName,
            templateNames,
            isPublic ? "Save Public Search Template" : "Save Search Template (Private)"
        );

        if (string.IsNullOrWhiteSpace(templateName))
            return;

        await GridModel.SaveTemplate(templateName, isPublic);

        var savedas = isPublic ? "public" : "private";
        NotificationService.Success($"Settings successfully saved as {savedas} template");

        await templateDropdown.LoadTemplates(GridModel.LoadedTemplate);
    }

    public void OnGroup(DataGridColumnGroupEventArgs<TItem> args)
    {
        if (args.GroupDescriptor == null)
        {
            if (!Grid.Groups.Any()) PageSize = OriginalPageSize;
            return;
        }

        Grid.OrderBy(args.Column.Property);

        var pageOptions = pageSizes.ToList();
        if (OriginalPageSize == pageOptions.Last() || PageSize > OriginalPageSize) return;

        var nextSize = pageOptions.Next(PageSize);
        PageSize = nextSize;
    }


}