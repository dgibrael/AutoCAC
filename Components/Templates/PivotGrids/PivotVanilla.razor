@typeparam TItem where TItem : class

@using AutoCAC.Components.Templates
@using AutoCAC.Models
@using System.Text.Json
@inject IDbContextFactory<AutoCAC.Models.mainContext> DbFactory
@inject AutoCAC.Services.UserContextService UserContext
@inject DialogService DialogService
@inject NotificationService NotificationService

<LoadingContent IsLoading="@(GridModel is null)">
    <RadzenSplitButton Text="Save Template" Icon="save"
                       Click="@(item => SaveGridSettingsClick(item))"
                       ButtonStyle="ButtonStyle.Base">
        <RadzenSplitButtonItem Text="Save Template" Value="private" Icon="account_circle" />
        <RadzenSplitButtonItem Text="Save Public Template" Value="public" Icon="public" />
    </RadzenSplitButton>
    <SearchTemplateDropown DataGridName="@GridModel.PageName" @ref="templateDropdown"
                           SelectedTemplateChanged="OnTemplatePicked" InitialValue="GridModel.InitialTemplate"
                           Placeholder="Load Saved Template..." />
    <RadzenPivotDataGrid @ref=Grid IsLoading="@IsLoading" Data=@GridModel.Data Count="@GridModel.Count" 
                         LoadData="@LoadData" TItem="TItem"
                         AllowPaging="true" PageSize="20" PageSizeOptions="pageSizes" @key="pivotKey"
                         AllowFieldsPicking="true" AllowFiltering="true" AllowSorting="true"
                         ShowColumnsTotals="true" ShowRowsTotals="true" AllowDrillDown="true" FieldsPickerExpanded="true"
                         GridLines="Radzen.DataGridGridLines.Default" AllowAlternatingRows="true">
        <Columns>
            @if (GridModel?.PivotSettings == null)
            {
                foreach (var p in typeof(TItem).GetProperties())
                {
                    <RadzenPivotColumn Property="@p.Name" Title="@p.Name" />
                }
            }
            else if (GridModel.PivotSettings?.ColumnFields.Any() == true)
            {
                foreach (var c in GridModel.PivotSettings.ColumnFields)
                {
                    <RadzenPivotColumn Property="@c" Title="@c" />
                }
            }
        </Columns>
        <Rows>
            @if (GridModel?.PivotSettings != null && GridModel.PivotSettings?.RowFields.Any() == true)
            {
                foreach (var r in GridModel.PivotSettings.RowFields)
                {
                    <RadzenPivotRow Property="@r" Title="@r" />
                }
            }
        </Rows>

        <Aggregates>
            @if (GridModel?.PivotSettings != null && GridModel.PivotSettings?.Aggregates.Any() == true)
            {
                foreach (var agg in GridModel.PivotSettings.Aggregates)
                {
                    <RadzenPivotAggregate Property="@agg?.Property"
                                          Title="@agg?.Title" 
                                          Aggregate="@(Enum.Parse<AggregateFunction>(agg.Aggregate))"
                                          FormatString="@agg?.FormatString"  />
                }
            }
        </Aggregates>
    </RadzenPivotDataGrid>
</LoadingContent>

@code {
    [Parameter] public DataGridHelper<TItem> GridModel { get; set; } = new();
    int pivotKey = 0;
    RadzenPivotDataGrid<TItem> Grid;
    private int[] pageSizes = { 5, 10, 20, 30, 50 };
    private bool IsLoading = true;
    public SearchTemplateDropown templateDropdown;
    bool pendingFieldSetup = true;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            GridModel.DataGridName = string.IsNullOrEmpty(GridModel?.DataGridName) ||
                                        GridModel.DataGridName == typeof(TItem).Name ?
                                        typeof(TItem).Name + "Pivot" : GridModel.DataGridName;
            GridModel.IsPivotTable = true;
            GridModel.Initialize(
                DbFactory,
                UserContext.Username,
                reloadAsync: () => InvokeAsync(() => Grid.FirstPage(true))
            );
            await InvokeAsync(StateHasChanged);
            return;
        }
        if (pendingFieldSetup)
        {
            pendingFieldSetup = false;
            foreach (var p in typeof(TItem).GetProperties())
            {
                Grid.AddPivotField(new RadzenPivotField<TItem>
                {
                    Property = p.Name,
                    Title = p.Name
                });
            }
            await InvokeAsync(StateHasChanged);
        }
    }

    public async Task LoadData(LoadDataArgs args)
    {
        IsLoading = true;
        try
        {
            await GridModel.LoadAsync(args);
        }
        catch (Exception ex)
        {
            await DialogService.Alert(ex.Message, "Load Error");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    public async Task SaveGridSettingsClick(RadzenSplitButtonItem item)
    {
        var isPublic = GridModel.LoadedTemplate?.IsShared == true;
        // Override default if the user explicitly selected a value
        if (item?.Value != null)
        {
            var value = item.Value.ToString();
            if (string.Equals(value, "public", StringComparison.OrdinalIgnoreCase))
                isPublic = true;
            else if (string.Equals(value, "private", StringComparison.OrdinalIgnoreCase))
                isPublic = false;
        }
        var templates = await GridModel.GetTemplatesAsync();
        var templateNames = templates.Select(x => x.TemplateName);
        var templateName = await DialogService.AutoCompleteDialogAsync(
            GridModel.LoadedTemplate?.TemplateName,
            templateNames,
            isPublic ? "Save Public Search Template" : "Save Search Template (Private)"
        );
        if (string.IsNullOrWhiteSpace(templateName))
            return;
        await GridModel.SaveTemplate(templateName, isPublic, Grid);
        var savedas = isPublic ? "public" : "private";
        NotificationService.Success($"Settings successfully saved as {savedas} template");
        await templateDropdown.LoadTemplates(GridModel.LoadedTemplate);
    }

    public async Task OnTemplatePicked(DataGridTemplate tmpl)
    {
        GridModel.LoadedTemplate = tmpl;
        if (tmpl == null) return;
        var json = tmpl?.DataGridSettings;
        GridModel.PivotSettings = string.IsNullOrWhiteSpace(json)
            ? null
            : JsonSerializer.Deserialize<PivotGridSettings>(json);
        pivotKey++;
    }

}

