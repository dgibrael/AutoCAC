@page "/wardstock"
@using AutoCAC.Models
@using AutoCAC.Components.Templates
@using AutoCAC.Components.Templates.Buttons
@using AutoCAC.Services
@inject IDbContextFactory<mainContext> DbFactory
@inject NavigationManager Nav
@inject NotificationService NotificationService
@inject UserContextService UserContext
@inject DialogService DialogService
<AuthVanilla Path="wardstock/admin">
	<SplitButtonUrlsTemplate ButtonText="Admin"
							 UrlKeyLabelValue="@(new Dictionary<string, string>
							 		{
        								{ "wardstock/admin/users", "Edit Users" },
										{ "wardstock/admin/locations", "Edit Locations" }
    						 		})" />
</AuthVanilla>

<DataGridVanilla TItem="AutoCAC.Models.WardstockDto" GridModel="GridModel" AddButtonClick="@AddBtnClick">
	<RadzenDataGridColumn TItem="AutoCAC.Models.WardstockDto" Property="Status" Title="Status" FilterMode="FilterMode.CheckBoxList" />
	<RadzenDataGridColumn TItem="AutoCAC.Models.WardstockDto" Property="LastModifiedDateTime" Title="LastModifiedDateTime" />
	<RadzenDataGridColumn TItem="AutoCAC.Models.WardstockDto" Property="LocationName" Title="Location"
						  FilterMode="FilterMode.CheckBoxList" />
	<RadzenDataGridColumn TItem="AutoCAC.Models.WardstockDto" Property="OrderDateTime" Title="OrderDateTime" />
	<ActionColumn TItem="AutoCAC.Models.WardstockDto" Context="row">
		<RadzenButton Icon="edit"
					  ButtonStyle="ButtonStyle.Primary"
					  Variant="Variant.Text"
					  Click="@(() => Nav.NavigateToRelative(row.Id.ToString()))" />
		<RadzenButton Icon="delete"
					  ButtonStyle="ButtonStyle.Danger"
					  Variant="Variant.Text" Disabled="!_isSupervisor"
					  Click="@(() => OnDeleteAsync(row))" />
	</ActionColumn>
</DataGridVanilla>

@code {
	private int _userId;
	private bool _isPharmacy;
	private bool _isSupervisor;
	private HashSet<int> _myLocations;
	private DataGridHelper<AutoCAC.Models.WardstockDto> GridModel = new();
	protected override void OnInitialized()
	{
		GridModel.QueryFactory = db =>
			db.WardstockOrders
			.Include(x => x.Location)
			.Select(x => new WardstockDto
			{
				Id = x.Id,
				LastModifiedDateTime = x.LastModifiedDateTime,
				LocationId = x.LocationId,
				LocationName = x.Location.LocationName,
				OrderDateTime = x.OrderDateTime,
				Status = x.Status
			}
			)
			.Where(x =>
				_isSupervisor ||
				(_isPharmacy && x.Status != "New") ||
				(_myLocations != null && _myLocations.Contains(x.LocationId))
			)
			.OrderBy(x => x.LastModifiedDateTime)
			.AsQueryable().AsNoTracking();
	}
	protected override async Task OnInitializedAsync()
	{
		_isSupervisor = UserContext.IsInGroupOrSuperuser("PharmacyTechSupervisor", "PharmacistSupervisor");
		_isPharmacy = UserContext.IsInGroup("PharmacyTech", "Pharmacist");
		_userId = UserContext.UserProfile.Id;
		await using var db = await DbFactory.CreateDbContextAsync();
		_myLocations = await db.WardstockUserlocations.Where(x => x.AuthUserId == _userId).Select(x => x.LocationId).ToHashSetAsync<int>();
	}
	private async Task AddBtnClick()
	{
		var locCount = _myLocations.Count;
		if (locCount == 0) return;
		var newOrder = new WardstockOrder
			{
				LastModifiedDateTime = DateTime.Now,
				StatusEnum = WardstockOrderStatus.New,
				OrderDateTime = DateTime.Now
			};
		int selectedLoc;
		if (locCount == 1)
		{
			selectedLoc = _myLocations.FirstOrDefault();
			newOrder.LocationId = selectedLoc;
		}
		else
		{
			await using var db = await DbFactory.CreateDbContextAsync();
			var locNames = await db.WardstockUserlocations.Where(x => x.AuthUserId == _userId)
							.Select(x => x.Location.LocationName)
							.Order()
							.ToHashSetAsync();
			var selectedName = await DialogService.ListDialogAsync(locNames);
			if (selectedName != null)
			{
				var selectedLocFull = await db.WardstockUserlocations.FirstOrDefaultAsync(x => x.AuthUserId == _userId && x.Location.LocationName == selectedName);
				selectedLoc = selectedLocFull.LocationId;
				newOrder.LocationId = selectedLoc;
			}
		}
		newOrder = await DbFactory.AddItemAsync(newOrder);
		var activity = new WardstockActivitylog
		{
			AuthUserId = UserContext.UserProfile.Id,
			WardstockOrderId = newOrder.Id,
			ActivityAt = DateTime.Now,
			Remarks = $"New Order Created"
		};
		await DbFactory.UpdateItemAsync(activity);
		Nav.NavigateToRelative(newOrder.Id.ToString());
	}

	private async Task OnDeleteAsync(WardstockDto item)
	{
		var confirm = await DialogService.Confirm("Are you sure you want to delete?");
		if (confirm != true) return;
		var itemId = await DbFactory.DeleteByPkAsync<WardstockOrder>(item.Id);
		await GridModel.ReloadAsync();
	}
}
