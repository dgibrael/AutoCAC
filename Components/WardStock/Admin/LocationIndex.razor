@page "/wardstock/admin/locations"
@using AutoCAC.Components.Templates
@using AutoCAC.Models
@inject IDbContextFactory<mainContext> DbFactory
@inject NavigationManager Nav
@inject DialogService DialogService
@inject NotificationService Notifications
<DataGridVanilla TItem="AutoCAC.Models.WardstockLocation" QueryFactory="@Qry()" @ref="grid" AddButtonClick="@AddBtnClick">
    <RadzenDataGridColumn TItem="AutoCAC.Models.WardstockLocation" Property="LocationName" Title="LocationName" />
    <RadzenDataGridColumn TItem="AutoCAC.Models.WardstockLocation" Property="InactiveDate" Title="InactiveDate" />
    <ActionColumn TItem="AutoCAC.Models.WardstockLocation" Context="data">
        <RadzenButton Icon="edit"
                      ButtonStyle="ButtonStyle.Primary"
                      Variant="Variant.Text"
                      Click="@(() => Nav.NavigateToRelative(data.Id.ToString()))" />
        <RadzenButton Text="@(data?.InactiveDate == null ? "Deactivate" : "Re-Activate" )"
                      ButtonStyle="ButtonStyle.Primary"
                      Variant="Variant.Text"
                      Click="@(() => ToggleActivated(data))" />
    </ActionColumn>
</DataGridVanilla>

@code {
    private DataGridVanilla<WardstockLocation> grid;
    private Func<AutoCAC.Models.mainContext, IQueryable<AutoCAC.Models.WardstockLocation>> Qry()
    {
        //make sure to add QueryFactory="@Qry()" to datagrid params
        return db => db.WardstockLocations
            .OrderBy(x => x.LocationName)
            .AsQueryable().AsNoTracking();
    }
    private async Task ToggleActivated(AutoCAC.Models.WardstockLocation location)
    {
        location.InactiveDate = location.InactiveDate == null ? DateOnly.FromDateTime(DateTime.Now) : null;
        await DbFactory.UpdateItemAsync(location);
        await grid.ForceReload();
    }

    private async Task AddBtnClick()
    {
        var locName = await DialogService.TextPromptAsync(
            "New Location",
            "Enter New Location Name");

        if (string.IsNullOrWhiteSpace(locName))
            return;

        await using var db = await DbFactory.CreateDbContextAsync();

        var location = await db.WardstockLocations
            .FirstOrDefaultAsync(x => x.LocationName == locName);

        if (location is null)
        {
            location = new WardstockLocation
            {
                LocationName = locName
            };

            db.WardstockLocations.Add(location);
            await db.SaveChangesAsync();
        }
        else
        {
            Notifications.Notify(detail: "Location already exists");
        }

        long locId = location.Id;

        Nav.NavigateToRelative(locId.ToString());
    }

}
