@page "/wardstock/admin/users"
@inject DialogService DialogService
@using AutoCAC.Models
@inject IDbContextFactory<mainContext> DbFactory
@inject NavigationManager Nav
<DataGridVanilla TItem="AutoCAC.Models.AuthUser" GridModel="GridModel" AddButtonClick="OnAddClick">
    <RadzenDataGridColumn TItem="AutoCAC.Models.AuthUser" Property="Username" Title="Username" />
    <RadzenDataGridColumn TItem="AutoCAC.Models.AuthUser" Property="LastName" Title="Last Name" />
    <RadzenDataGridColumn TItem="AutoCAC.Models.AuthUser" Property="FirstName" Title="First Name" />
    <ActionDefaultColumn TItem="AutoCAC.Models.AuthUser" ShowDelete="false" />
</DataGridVanilla>

@code {
    private DataGridHelper<AutoCAC.Models.AuthUser> GridModel = new()
    {
        QueryFactory = db => db.AuthUsers
              .Where(u => db.WardstockUserlocations
                             .Any(w => w.AuthUserId == u.Id))
              .OrderBy(x => x.Username),
        SearchColumns = new[] { "Username", "LastName", "FirstName" }
    };
    private async Task OnAddClick()
    {
        var selected = await DialogService.StaffAdDialog();
        if (selected is null) return;
        await using var db = await DbFactory.CreateDbContextAsync();
        var user = await db.AuthUsers.FirstOrDefaultAsync(x => x.Username.ToLower() == selected.d1Username.ToLower());
        Nav.NavigateToRelative(user.Id.ToString());
    }
}
