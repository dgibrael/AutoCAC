@page "/wardstock/admin/locations/{Id:int}"
@using AutoCAC.Models
@using AutoCAC.Components.Templates.Forms
@using AutoCAC.Components.Templates.Buttons
@inject IDbContextFactory<mainContext> DbFactory
@inject NavigationManager Nav
@inject DialogService DialogService
<BackLink />
<LoadingContent IsLoading="@(!pageLoaded)">
	<RadzenTemplateForm TItem="WardstockLocation" Data="@pageItem" Submit="@OnSubmit">
		<VanillaFormField Label="Location Name">
			<RadzenTextBox @bind-Value="@(pageItem.LocationName)" Disabled="!metaEdit" />
		</VanillaFormField>
		@if(metaEdit)
		{
			<StandardButtons CancelClick="ToggleMetaEdit" SubmitText="Save Property Changes"/>
		}
		else
		{
			<RadzenButton Click="ToggleMetaEdit" ButtonType="ButtonType.Button" Text="Edit Attributes" 
				Size="ButtonSize.Medium" Icon="edit" />
		}
	</RadzenTemplateForm>
	<DataGridEditable TItem="AutoCAC.Models.WardstockItem" AddAction="SelectNewDrug" GridModel="GridModel">
		<RadzenDataGridColumn TItem="AutoCAC.Models.WardstockItem" Property="Drug.Name" Title="Drug" />
		<RadzenDataGridColumn TItem="AutoCAC.Models.WardstockItem" Property="Par" Title="Par">
			<EditTemplate Context="row">
				<RadzenNumeric @bind-Value="row.Par"  />
			</EditTemplate>
		</RadzenDataGridColumn>
	</DataGridEditable>
</LoadingContent>
<BackLink />
	@code {
	[Parameter] public int Id { get; set; }
	private bool metaEdit = false;
	private bool pageLoaded = false;
	private WardstockLocation pageItem;

	async Task ToggleMetaEdit()
	{
		metaEdit = !metaEdit;
		await LoadPageItem();
		StateHasChanged();
	}
	private DataGridHelper<AutoCAC.Models.WardstockItem> GridModel = new();
	protected override void OnInitialized()
	{
		GridModel.QueryFactory = db => db.WardstockItems
				.Include(x => x.Drug)
				.Where(x => x.LocationId == Id)
				.AsQueryable();
	}
	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (!firstRender) return;
		await LoadPageItem();
		pageLoaded = true;
		StateHasChanged();
	}

	private async Task LoadPageItem()
	{
		await using var db = await DbFactory.CreateDbContextAsync();
		pageItem = await db.WardstockLocations
							.Include(x => x.WardstockItems)
								.ThenInclude(x => x.Drug)
							.FirstOrDefaultAsync(x => x.Id == Id);
	}

	private async Task OnSubmit()
	{
		await DbFactory.UpdateItemAsync(pageItem);
		await LoadPageItem();
		metaEdit = false;
	}

	private async Task<WardstockItem> SelectNewDrug()
	{
		await LoadPageItem();
		var curSelected = pageItem.WardstockItems.Select(x => x.Drug.Id).ToHashSet();
		var selected = await DialogService.DrugSelectDialogAsync(x => !curSelected.Contains(x.Id));
		return new WardstockItem
			{
				LocationId = Id,
				DrugId = selected.Id,
				Drug = selected,
				Par = 0
			};

	}
}
