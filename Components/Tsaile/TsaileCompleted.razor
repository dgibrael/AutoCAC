@page "/tsaile/completed"
@using AutoCAC.Models
@using AutoCAC.Services
@using AutoCAC.Components.Templates.Buttons
@inject DialogService DialogService
@inject IDbContextFactory<mainContext> DbFactory
@inject UserContextService UserContext
@inject NotificationService NotificationService
@inject NavigationManager Nav
@inject LookupValueService Lookup
@using AutoCAC.Extensions.Tsaile
<RadzenLink Text="Main Que" Path="tsaile" Icon="home" />
<RadzenLink Text="Deleted Items" Path="tsaile/deleted" Icon="folder_delete" />
<DataGridVanilla TItem="AutoCAC.Models.TsaileBetterq" GridModel="GridModel">
    <HeaderContent>
        <RadzenButton Text="Search by Ticket#" Click="TicketSearch" Icon="search" />
    </HeaderContent>
    <ChildContent>
        <RadzenDataGridColumn TItem="AutoCAC.Models.TsaileBetterq" Property="CompletedDateTime" Title="Completed At" />
        <RadzenDataGridColumn TItem="AutoCAC.Models.TsaileBetterq" Property="Patient.Name" Title="Name" />
        <RadzenDataGridColumn TItem="AutoCAC.Models.TsaileBetterq" Property="Patient.ChartNumber" Title="Chart #" />
        <RadzenDataGridColumn TItem="AutoCAC.Models.TsaileBetterq" Property="Waiting" Title="Waiting"
                              FilterMode="FilterMode.CheckBoxList" />
        <RadzenDataGridColumn TItem="AutoCAC.Models.TsaileBetterq" Property="BatchTo" Title="Batched To" FilterMode="FilterMode.CheckBoxList" />
        <RadzenDataGridColumn TItem="AutoCAC.Models.TsaileBetterq" Property="ControlledSubstance" Title="ControlledSubstance"
                              FilterMode="FilterMode.CheckBoxList" />
        <RadzenDataGridColumn TItem="AutoCAC.Models.TsaileBetterq" Property="CreatedDateTime" Title="Created At" />
        <ActionColumn TItem="AutoCAC.Models.TsaileBetterq" Context="row" Width="250px">
            <SplitButtonTemplate DefaultButtonValue="Back"
                                 ButtonText="Undo Complete"
                                 MainIcon="undo"
                                 Buttons="@BuildButtons(row)" />
        </ActionColumn>
    </ChildContent>
</DataGridVanilla>

@code {
    private int _userId { get; set; } = 0;
    protected override void OnInitialized()
    {
        _userId = UserContext.UserProfile.Id;
    }
    private DataGridHelper<AutoCAC.Models.TsaileBetterq> GridModel = new()
    {
        QueryFactory = db => db.TsaileBetterqs
            .Where(x => x.Status == TsaileTicketStatus.Complete.ToString())
            .Include(x => x.Patient)
            .OrderByDescending(x => x.CompletedDateTime)
            .AsQueryable(),
        SearchColumns = new[] { "Patient.Name", "Patient.ChartNumber" }
    };

    IEnumerable<SplitButtonItem> BuildButtons(TsaileBetterq row) => new[]
    {
        new SplitButtonItem
        {
            Text = "Edit",
            Value = "Edit",
            Icon = "edit",
            IconColor = Colors.Primary,
            Action = async () =>
            {
                Nav.NavigateToWithExistingQry($"tsaile/ticket/{row.Id}");
            }
        },
        new SplitButtonItem
        {
            Text = "Send ticket back",
            Value = "Back",
            Icon = "undo",
            IconColor = Colors.WarningLight,
            Disabled = () => row.Status == TsaileTicketStatus.ReadyForPickup.ToString(),
            Action = async () =>
            {
                await DbFactory.ReverseStatusAndSaveAsync(row.Id, _userId, Lookup.GetValues("TsaileSkipVerify"));
                NotificationService.Success($"Status updated to {row.Status}");
                await GridModel.ReloadAsync();
            }
        },
        new SplitButtonItem
        {
            Text = "Delete",
            Value = "Delete",
            Icon = "delete",
            IconColor = Colors.Danger,
            Action = async () =>
            {
                var confirm = await DialogService.DeleteConfirm("Ticket");
                if (confirm == true)
                {
                    await row.UpdateStatusAsync(DbFactory, TsaileTicketStatus.Deleted.ToString(), _userId);
                    NotificationService.Success($"Moved to Trash");
                    await GridModel.ReloadAsync();
                }
            }
        },
        new SplitButtonItem
        {
            Text = "Change Status",
            Value = "ChangeStatus",
            Icon = "edit",
            IconColor = Colors.Info,
            Action = async () =>
            {
                string newStatus = await DialogService.ListDialogAsync(Enum.GetNames<TsaileTicketStatus>().ToHashSet());
                if (newStatus == null) return;
                await row?.UpdateStatusAsync(DbFactory, newStatus, _userId);
                NotificationService.Success($"Status updated to {row?.Status}");
                await GridModel.ReloadAsync();
            }
        },
    };
    public async Task TicketSearch()
    {
        var ticketNum = await DialogService.IntPromptAsync("Ticket Search", "Enter ticket#");
        if (ticketNum == null) return;
        Nav.NavigateTo($"/tsaile/ticket/{ticketNum}");
    }
}