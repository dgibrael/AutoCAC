@page "/tsaile"
@using AutoCAC.Models
@using AutoCAC.Services
@using AutoCAC.Extensions.Tsaile
@using AutoCAC.Components.Templates.Buttons
@inject DialogService DialogService
@inject IDbContextFactory<mainContext> DbFactory
@inject UserContextService UserContext
@inject NotificationService NotificationService
@inject NavigationManager Nav
@inject TsaileTicketWatcher Notifier
@implements IDisposable
<RadzenLink Text="Go to Deleted Items" Path="tsaile/deleted" Icon="folder_delete"  />
<RadzenLink Text="Go to Completed Items" Path="tsaile/completed" Icon="checklist" />
<DataGridVanilla TItem="TsaileBetterqDto" GridModel="GridModel" CellRender="CellFormat" RowDoubleClick="@(e => Nav.NavigateToRelative(e.Data.Id.ToString()))">
    <RadzenDataGridColumn TItem="TsaileBetterqDto" Property="WaitTime" Title="Minutes Waited" />
    <RadzenDataGridColumn TItem="TsaileBetterqDto" Property="PatientName" Title="Name" />
    <RadzenDataGridColumn TItem="TsaileBetterqDto" Property="ChartNumber" Title="Chart #" />
    <RadzenDataGridColumn TItem="TsaileBetterqDto" Property="Status" Title="Status" FilterMode="FilterMode.CheckBoxList"/>
    <BoolColumn TItem="TsaileBetterqDto" Property="ControlledSubstance" Title="ControlledSubstance" ColumnIndex="5"/>
    <BoolColumn TItem="TsaileBetterqDto" Property="Waiting" Title="Waiting" ColumnIndex="6"/>
    <BoolColumn TItem="TsaileBetterqDto" Property="NeedsCounseling" Title="Needs Counseling" ColumnIndex="7"/>
    <RadzenDataGridColumn TItem="TsaileBetterqDto" Property="LastModifiedDateTime" Title="Last Modified" />
    <RadzenDataGridColumn TItem="TsaileBetterqDto" Property="CreatedDateTime" Title="Created At" />
    <RadzenDataGridColumn TItem="TsaileBetterqDto" Property="CalledDateTime" Title="Called At" />
    <RadzenDataGridColumn TItem="TsaileBetterqDto" Property="LockedDateTime" Title="Locked At" />
    <RadzenDataGridColumn TItem="TsaileBetterqDto" Property="Efdt" Title="Earliest Fill Date" />
    <ActionColumn TItem="TsaileBetterqDto" Context="row" Width="250px">
        <SplitButtonTemplate DefaultButtonValue="@(_forwardAsDefault(row) ? "Forward" : "Edit")"
            ButtonText="@(_forwardAsDefault(row) ? $"Move to {row?.StatusEnum.Next()}" : "Edit")"
            MainIcon="@(_forwardAsDefault(row) ? "forward" : "edit")"
            Buttons="@BuildButtons(row)" />
    </ActionColumn>
</DataGridVanilla>

@code {
    private DataGridVanilla<TsaileBetterqDto> grid;
    private DataGridHelper<AutoCAC.Models.TsaileBetterqDto> GridModel = new()
    {
        QueryFactory = db => db.TsaileBetterqs
            .Where(x => x.CompletedDateTime == null)
            .Include(x => x.Patient)
            .Select(x => new TsaileBetterqDto
            {
                Id = x.Id,
                CreatedDateTime = x.CreatedDateTime,

                // 👇 THIS IS THE KEY LINE
                WaitTime = EF.Functions.DateDiffMinute(
                    x.CreatedDateTime,
                    DateTime.Now
                ),

                Status = x.Status,
                Waiting = x.Waiting,
                NeedsCounseling = x.NeedsCounseling,
                ControlledSubstance = x.ControlledSubstance,
                LockedDateTime = x.LockedDateTime,
                LastModifiedDateTime = x.LastModifiedDateTime,
                CalledDateTime = x.CalledDateTime,
                Efdt = x.Efdt,
                PatientName = x.Patient.Name,
                ChartNumber = x.Patient.ChartNumber
            }),
        AddButtonDefault = true,
        SearchColumns = new[] { "Patient.Name", "Patient.ChartNumber" },
        CustomChoices = new Dictionary<string, IEnumerable<object>>
        { ["Status"] = Enum.GetNames<TsaileTicketStatus>() }
    };
    private int _userId { get; set; } = 0;
    protected override void OnInitialized()
    {
        _userId = UserContext.UserProfile.Id;
        Notifier.QueueChanged += Reload;
    }

    private bool _forwardAsDefault(TsaileBetterqDto row)
    {
        return row?.StatusEnum != null && row?.StatusEnum is
                                                (TsaileTicketStatus.Filling or TsaileTicketStatus.Verifying or
                                                TsaileTicketStatus.ReadyForPickup or TsaileTicketStatus.Screening);
    }

    void CellFormat(DataGridCellRenderEventArgs<TsaileBetterqDto> args)
    {
        if (!args.Data.Waiting) return;
        switch (args.Data.WaitTime)
        {
            case > 60:
                args.Attributes.Add("class", "rz-background-color-danger-lighter");
                break;
            case > 30:
                args.Attributes.Add("class", "rz-background-color-warning-lighter");
                break;
        }
    }

    private void Reload()
    {
        InvokeAsync(() =>
        {
            grid?.Grid?.Reload();
            StateHasChanged();
        });
    }
    IEnumerable<SplitButtonItem> BuildButtons(TsaileBetterqDto row) => new[]
    {
        new SplitButtonItem
        {
            Text = "Edit",
            Value = "Edit",
            Icon = "edit",
            IconColor = Colors.Primary,
            Action = async () =>
            {
                Nav.NavigateToRelative(row.Id.ToString());
            }
        },
        new SplitButtonItem
        {
            Text = row?.StatusEnum == null || row?.StatusEnum ==  TsaileTicketStatus.Screening ? "Already at Beginning" 
                    : $"Move to {row?.StatusEnum.Previous()}",
            Value = "Back",
            Icon = "undo",
            IconColor = Colors.WarningLight,
            Disabled = () => row.Status == TsaileTicketStatus.Screening.ToString(),
            Action = async () =>
            {
                var ticket = await DbFactory.ReverseStatusAndSaveAsync(row.Id, _userId);
                NotificationService.Success($"Status updated to {ticket.Status}");
                await GridModel.ReloadAsync();
            }
        },
        new SplitButtonItem
        {
            Text = row?.StatusEnum == null || row?.StatusEnum ==  TsaileTicketStatus.Complete ? "Already Completed"
                    : $"Move to {row?.StatusEnum.Next()}",
            Value = "Forward",
            Icon = "forward",
            IconColor = Colors.Success,
            Disabled = () => row.Status == TsaileTicketStatus.Complete.ToString(),
            Action = async () =>
            {

                var ticket = await DbFactory.AdvanceStatusAndSaveAsync(row.Id, _userId);
                NotificationService.Success($"Status updated to {ticket.Status}");
                await GridModel.ReloadAsync();
            }
        },
        new SplitButtonItem
        {
            Text = "Delete",
            Value = "Delete",
            Icon = "delete",
            IconColor = Colors.Danger,
            Action = async () =>
            {
                var confirm = await DialogService.DeleteConfirm("Ticket");
                if (confirm == true)
                {
                    await DbFactory.UpdateStatusAsync(row.Id, TsaileTicketStatus.Deleted.ToString(), _userId);
                    NotificationService.Success($"Moved to Trash");
                    await GridModel.ReloadAsync();
                }
            }
        },
        new SplitButtonItem
        {
            Text = "Change Status",
            Value = "ChangeStatus",
            Icon = "edit",
            IconColor = Colors.Info,
            Action = async () =>
            {
                string newStatus = await DialogService.ListDialogAsync(Enum.GetNames<TsaileTicketStatus>().ToHashSet());
                if (newStatus == null) return;
                var ticket = await DbFactory?.UpdateStatusAsync(row.Id, newStatus, _userId);
                NotificationService.Success($"Status updated to {ticket?.Status}");
                await GridModel.ReloadAsync();
            }
        },
    };
    public void Dispose()
    {
        Notifier.QueueChanged -= Reload;
    }

}
