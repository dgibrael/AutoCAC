@page "/tsaile"
@page "/tsaile/futurefills"
@using AutoCAC.Models
@using AutoCAC.Services
@using AutoCAC.Extensions.Tsaile
@using AutoCAC.Components.Templates.Buttons
@inject DialogService DialogService
@inject IDbContextFactory<mainContext> DbFactory
@inject UserContextService UserContext
@inject NotificationService NotificationService
@inject NavigationManager Nav
@inject TsaileTicketWatcher Notifier
@inject LookupValueService Lookup
@inject IRecordUnlockService UnlockService
@implements IDisposable

<RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Start" AlignItems="AlignItems.Start">
    @if(IsFutureFills)
    {
        <RadzenLink Text="Main Que" Path="tsaile" Icon="home" />
    }
    else
    {
        <RadzenLink Text="Future Fills" Path="tsaile/futurefills" Icon="event_upcoming"  />
    }
    <RadzenLink Text="Deleted Items" Path="tsaile/deleted" Icon="folder_delete"  />
    <RadzenLink Text="Completed Items" Path="tsaile/completed" Icon="checklist" />
</RadzenStack>
<DataGridVanilla TItem="TsaileBetterq" GridModel="GridModel" CellRender="CellFormat" 
        RowDoubleClick="@(e => EditTicket(e.Data))" AddButtonClick="NewTicket">
    <HeaderContent>
        <RadzenButton Text="Search by Ticket#" Click="TicketSearch" Icon="search"/>
        <RadzenButton Text="Patient Profile Search" Click="PatientProfileSearch" Icon="person"/>
    </HeaderContent>
    <ChildContent>
        <RadzenDataGridColumn TItem="TsaileBetterq" Property="CreatedDateTime" Title="Created At" >
            <HeaderTemplate>
                <span class="rz-column-title-content rz-text-wrap">@($"Created At{(!IsFutureFills ? " (Minutes Waited)" : "")}")</span>
            </HeaderTemplate>
            <Template Context="x">
                <div class="rz-w-100 rz-text-wrap">
                    <span>@x?.CreatedDateTime</span>
                    @if (x?.CreatedDateTime != null)
                    {                    
                        if(x.Waiting)
                        {
                            <strong>@($" ({(int)Math.Round((DateTime.Now - (x.CalledDateTime ?? x.CreatedDateTime)).TotalMinutes)})")</strong>
                        }
                    }
                </div>
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="TsaileBetterq" Property="Patient.Name" Title="Name" />
        <RadzenDataGridColumn TItem="TsaileBetterq" Property="Patient.ChartNumber" Title="Chart #" />
        <RadzenDataGridColumn TItem="TsaileBetterq" Property="Status" Title="Status" FilterMode="FilterMode.CheckBoxList"/>
        <RadzenDataGridColumn TItem="TsaileBetterq" Property="BatchTo" Title="Batched To" FilterMode="FilterMode.CheckBoxList"/>
        <BoolColumn TItem="TsaileBetterq" Property="Waiting" Title="Waiting" ColumnIndex="4" Width="150px"/>
        <RadzenDataGridColumn TItem="TsaileBetterq" Property="Efdt" Title="Earliest Fill Date" />
        <BoolColumn TItem="TsaileBetterq" Property="ControlledSubstance" Title="CS" ColumnIndex="6" Width="100px"/>
        <RadzenDataGridColumn TItem="TsaileBetterq" Property="LastModifiedDateTime" Title="Last Modified" />
        <RadzenDataGridColumn TItem="TsaileBetterq" Property="CalledDateTime" Title="Called At" />
        <ActionColumn TItem="TsaileBetterq" Context="row" Width="200px">
            @if (row?.IsLocked == true)
            {
                <RadzenButton Text="@($"Locked by {row?.LockedBy?.DisplayName}")"
                Style="white-space: normal" Size="ButtonSize.Small" Icon="lock"
                                Click="@(async args => await OnLocked(row))" />
            }
            else
            {
                <SplitButtonTemplate DefaultButtonValue="@DefaultButtonValue(row)"
                Buttons="@BuildButtons(row)" ButtonSize="ButtonSize.Small" />
            }
        </ActionColumn>
    </ChildContent>
    <EmptyTemplate>
        <p>No ticket found, try one of these:</p>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Stretch">
            <RadzenButton Text="Search by Ticket#" Click="TicketSearch" Icon="search" Size="ButtonSize.Small" Variant="Variant.Text" />
            <RadzenButton Text="Patient Profile Search" Click="PatientProfileSearch" Icon="person" Size="ButtonSize.Small" Variant="Variant.Text" />
            @if (IsFutureFills)
            {
                <RadzenLink Text="Main Que" Path="tsaile" Icon="home" />
            }
            else
            {
                <RadzenLink Text="Future Fills" Path="tsaile/futurefills" Icon="event_upcoming" />
            }
            <RadzenLink Text="Deleted Items" Path="tsaile/deleted" Icon="folder_delete" />
            <RadzenLink Text="Completed Items" Path="tsaile/completed" Icon="checklist" />
        </RadzenStack>
        <p><strong>If this is a new patient, go to "^TSAILE PATIENT SCHEDULED" in RPMS and press Enter at the "Requested Time To Print: NOW//" prompt.</strong></p>
        <strong>It will take about 1 to 2 minutes to update the patient list.</strong>
    </EmptyTemplate>
</DataGridVanilla>

@code {
    bool IsFutureFills => Nav.GetPath(includeExistingQry: false).Equals("/tsaile/futurefills", StringComparison.OrdinalIgnoreCase);
    private string DefaultButtonValue(TsaileBetterq row) => row.StatusEnum switch
    {
        TsaileTicketStatus.Verifying or TsaileTicketStatus.Filling => "Forward",
        TsaileTicketStatus.ReadyForPickup => "Call",
        _ => "Edit"
    };

    private DataGridHelper<TsaileBetterq> GridModel = new()
    {
        SearchColumns = new[] { "Patient.Name", "Patient.ChartNumber" }
    };
    private int _userId { get; set; } = 0;
    protected override async Task OnInitializedAsync()
    {
        _userId = UserContext.UserProfile.Id;
        var today = DateOnly.FromDateTime(DateTime.Now);
        GridModel.QueryFactory = db => db.TsaileBetterqs
            .Where(x => x.CompletedDateTime == null)
            .Where(x => !IsFutureFills ?
                x.Efdt == null || x.Efdt <= today :
                x.Efdt > today
            )
            .Include(x => x.Patient)
            .Include(x => x.LockedBy)
            .OrderByDescending(x => x.Waiting)
                .ThenBy(x => x.CreatedDateTime)
            ;
        Notifier.QueueChangedAsync += Reload;
        var batchOptions = Lookup.GetValues(LookupValueService.CommonOptionSet.TsaileBatchTo);

        GridModel.CustomChoices = new Dictionary<string, IEnumerable<object>>
        {
            ["Status"] = Enum.GetNames<TsaileTicketStatus>(),
            ["BatchTo"] = batchOptions
        };
    }

    private async Task PatientProfileSearch()
    {
        var selectedPatient = await DialogService.OpenAsync<TsaileSelectPatient>("Select a Patient", options: new DialogOptions { Width = "80%" });
        if (selectedPatient == null) return;
        Nav.NavigateToWithExistingQry($"/tsaile/patient/{selectedPatient.Id}");
    }

    private async Task NewTicket()
    {
        var selectedPatient = await DialogService.OpenAsync<TsaileSelectPatient>("Select a Patient", options: new DialogOptions { Width = "80%" });
        if (selectedPatient == null) return;
        Nav.NavigateTo($"/tsaile/new/{selectedPatient.Id}");
    }

    private async Task EditTicket(TsaileBetterq row)
    {
        if (row == null)
        {
            NotificationService.Info("Ticket not found");
            return;
        }
        if (row.IsLocked != true) 
        {
            Nav.NavigateToWithExistingQry($"/tsaile/ticket/{row.Id}");
            return;
        };
        string msg;
        if (row?.LockedBy?.Id == _userId)
        {
            msg = $"You have this ticket open in another session";
        }
        else
        {
            msg = $"Ticket is locked by {row?.LockedBy?.DisplayName}";
        }
        NotificationService.Notify(summary: "Locked", detail: msg);
        await GridModel.ReloadAsync();
    }

    private Task Reload()
        => GridModel.ReloadAsync();

    void CellFormat(DataGridCellRenderEventArgs<TsaileBetterq> args)
    {
        if (!args.Data.Waiting) return;
        var waitTime = (int)Math.Round((DateTime.Now - args.Data.CreatedDateTime).TotalMinutes);
        switch (waitTime)
        {
            case > 60:
                args.Attributes.Add("class", "rz-background-color-danger-lighter");
                break;
            case > 30:
                args.Attributes.Add("class", "rz-background-color-warning-lighter");
                break;
        }
    }

    IEnumerable<SplitButtonItem> BuildButtons(TsaileBetterq row) => new[]
    {
        new SplitButtonItem
        {
            Text = "Edit",
            Value = "Edit",
            Icon = "edit",
            IconColor = Colors.Primary,
            Action = async () =>
            {
                Nav.NavigateToWithExistingQry($"/tsaile/ticket/{row.Id}");
            }
        },
        new SplitButtonItem
        {
            Text = row?.StatusEnum == null || row?.StatusEnum ==  TsaileTicketStatus.Screening ? "Already at Beginning"
                    : $"Move ticket back",
            Value = "Back",
            Icon = "undo",
            IconColor = Colors.WarningLight,
            Disabled = () => row.Status == TsaileTicketStatus.Screening.ToString(),
            Action = async () =>
            {
                var ticket = await DbFactory.ReverseStatusAndSaveAsync(row.Id, _userId, Lookup.GetValues("TsaileSkipVerify"));
                NotificationService.Success($"Status updated to {ticket.Status}");
                await GridModel.ReloadAsync();
            }
        },
        new SplitButtonItem
        {
            Text = row?.StatusEnum == null || row?.StatusEnum ==  TsaileTicketStatus.Complete ? "Already Completed"
                    : $"Complete {row?.StatusEnum}",
            Value = "Forward",
            Icon = "forward",
            IconColor = Colors.Success,
            Disabled = () => row.Status == TsaileTicketStatus.Complete.ToString(),
            Action = async () =>
            {

                var ticket = await DbFactory.AdvanceStatusAndSaveAsync(row.Id, _userId, Lookup.GetValues("TsaileSkipVerify"));
                NotificationService.Success($"Status updated to {ticket.Status}");
                await GridModel.ReloadAsync();
            }
        },
        new SplitButtonItem
        {
            Text = "Delete",
            Value = "Delete",
            Icon = "delete",
            IconColor = Colors.Danger,
            Action = async () =>
            {
                var confirm = await DialogService.DeleteConfirm("Ticket");
                if (confirm == true)
                {
                    await DbFactory.UpdateStatusAsync(row.Id, TsaileTicketStatus.Deleted.ToString(), _userId);
                    NotificationService.Success($"Moved to Trash");
                    await GridModel.ReloadAsync();
                }
            }
        },
        new SplitButtonItem
        {
            Text = "Change Status",
            Value = "ChangeStatus",
            Icon = "edit",
            IconColor = Colors.Info,
            Action = async () =>
            {
                string newStatus = await DialogService.ListDialogAsync(Enum.GetNames<TsaileTicketStatus>().ToHashSet());
                if (newStatus == null) return;
                var ticket = await DbFactory?.UpdateStatusAsync(row.Id, newStatus, _userId);
                NotificationService.Success($"Status updated to {ticket?.Status}");
                await GridModel.ReloadAsync();
            }
        },
        new SplitButtonItem
        {
            Text = "Patient Profile",
            Value = "Patient",
            Icon = "person",
            IconColor = Colors.Info,
            Action = async () =>
            {
                Nav.NavigateToWithExistingQry($"/tsaile/patient/{row.PatientId}");
            }
        },
        new SplitButtonItem
        {
            Text = "Call Patient",
            Value = "Call",
            Icon = "record_voice_over",
            IconColor = Colors.Info,
            Disabled = () => row?.StatusEnum != TsaileTicketStatus.ReadyForPickup,
            Action = async () =>
            {
                await using var db = await DbFactory.CreateDbContextAsync();
                var curDateTime = DateTime.Now;
                await db.TsaileBetterqs
                    .Where(x => x.Id == row.Id)
                    .ExecuteUpdateAsync(s => s
                        .SetProperty(x => x.CalledDateTime, curDateTime));
                NotificationService.Success($"Patient marked as called at {curDateTime}");
                Nav.NavigateToWithExistingQry($"/tsaile/ticket/{row.Id}");
            }
        },
    };

    private readonly HashSet<long> _unlocking = new();

    private async Task ForceUnlockAsync(long recordId)
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        var entity = await db.TsaileBetterqs.FirstOrDefaultAsync(x => x.Id == recordId);
        if (entity == null)
            return;

        // force clear lock (covers crashed circuits / hot reload / missed Dispose)
        if (entity.LockedById != null || entity.LockedDateTime != null)
        {
            entity.LockedById = null;
            entity.LockedDateTime = null;
            await db.SaveChangesAsync();
        }
    }

    private async Task OnLocked(TsaileBetterq row)
    {
        if (row == null)
            return;

        long recordId = row.Id;

        if (_unlocking.Contains(recordId))
            return;
        bool? requestUnlock;
        if (row?.LockedById == _userId)
        {
            requestUnlock = true;
        }
        else
        {
            requestUnlock = await DialogService.YesNoDialog($"This ticket is locked by {row?.LockedBy?.DisplayName}, request unlock?", "Locked");
        }
        if (requestUnlock != true) return;
        _unlocking.Add(recordId);
        try
        {
            DialogService.ShowLoadingSpinner($"Requesting unlock for ticket {recordId}...");
            // Service behavior:
            // - if no subscriber => returns true immediately
            // - if no ack within 500ms => returns true
            // - if acked => waits 10s for confirm/deny; timeout => true
            var unlockConfirmed = await UnlockService.RequestUnlockAsync(recordId, UserContext.UserProfile);
            DialogService.Close();
            if (unlockConfirmed)
            {
                await ForceUnlockAsync(recordId);
                Nav.NavigateToWithExistingQry($"/tsaile/ticket/{recordId}");
                return;
            }

            NotificationService.Notify(summary: "Unlock Denied", detail: "The user denied your unlock request.");
            await GridModel.ReloadAsync();
        }
        finally
        {
            _unlocking.Remove(recordId);
        }
    }

    public async Task TicketSearch()
    {
        var ticketNum = await DialogService.IntPromptAsync("Ticket Search", "Enter ticket#");
        if (ticketNum == null) return;
        await using var db = await DbFactory.CreateDbContextAsync();
        var ticket = await db.TsaileBetterqs.FirstOrDefaultAsync(x => x.Id == ticketNum);
        await EditTicket(ticket);
    }

    public void Dispose()
    {
        Notifier.QueueChangedAsync -= Reload;
    }

}
