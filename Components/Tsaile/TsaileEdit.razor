@page "/tsaile/{Id:int}"

@using AutoCAC.Components.Templates.Forms
@using AutoCAC.Components.Templates.Buttons
@using AutoCAC.Components.Templates.Printing
@using AutoCAC.Components.Tsaile
@using AutoCAC.Models
@inject IDbContextFactory<mainContext> DbFactory
@using AutoCAC.Services
@inject UserContextService UserContext
@inject NavigationManager Nav
@inject NotificationService Notifications
@inject DialogService DialogService
@inject LookupValueService Lookup
@inject IRecordUnlockService UnlockService
@implements IAsyncDisposable
<LoadingContent IsLoading="@(item == null)" NotFoundMessage="@_notFoundMsg">
	<BackLink />
	<PrintContent PrintOnly="false">
		@if (item?.Waiting == true)
		{
			<h2 class="rz-color-warning">Waiter</h2>
		}
		else
		{
			<h2>Non-Waiter</h2>
		}

		<h2>@item?.BatchTo</h2>
		<h3>@($"Ticket for {item?.Patient?.Name} (HRN: {item?.Patient?.ChartNumber})")</h3>
		@if (item?.ControlledSubstance == true)
		{
			<h5 class="rz-color-warning">Order Has Controlled Substances</h5>
		}
		else
		{
			<h5>No Controlled Substances in order</h5>
		}
	</PrintContent>
	<h5>@($"Current status: {item?.Status}")</h5>
	<OpenDialogFormButton TItem="TsaileBetterq" Data="item" Title="Edit Attributes" Context="x" OnClose="LoadAndStateHasChanged" >
		<VanillaFormField Label="Waiter">
			<RadzenCheckBox @bind-Value="x.Waiting"/>
		</VanillaFormField>
		<VanillaFormField Label="Controlled Substance">
			<RadzenCheckBox @bind-Value="x.ControlledSubstance"/>
		</VanillaFormField>
		<VanillaFormField Label="Batch To">
			<RadzenDropDown @bind-Value="x.BatchTo" Data="_batchChoices" />
		</VanillaFormField>
		<VanillaFormField Label="Earliest Fill Date">
			<RadzenDatePicker @bind-Value="x.Efdt" ShowTime="false" />
		</VanillaFormField>
	</OpenDialogFormButton>
	<RadzenRow>
		<RadzenColumn Size="6">
			<CommentTemplate Title="Ticket Comments" TItem="TsaileComment" CommentQueryFactory="CommentQueryFactory" MapToEntity="MapComment" Print="true" />
		</RadzenColumn>
		<RadzenColumn Size="6">
			<CommentTemplate Title="Patient Comments" TItem="TsailePatientcomment" CommentQueryFactory="CommentQueryFactoryPatient" MapToEntity="MapCommentPatient" Print="false" />
		</RadzenColumn>
	</RadzenRow>
	<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Start">
		<SplitButtonTemplate Buttons="@BuildButtons()" 
				DefaultButtonValue="@(item?.StatusEnum == TsaileTicketStatus.Complete ? "Back" : "Submit")" />
		<PrintButton />
	</RadzenStack>
</LoadingContent>
	@code{
	[Parameter] public int Id { get; set; }
	private TsaileBetterq item { get; set; }
	private int _userId { get; set; } = 0;
	private string _notFoundMsg;
	private string[] _batchChoices;
	private bool _lockedByMe;
	private IDisposable _unlockSubscription;
	private bool _promptOpen;
	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			_batchChoices = await Lookup.GetValuesAsync(LookupValueService.CommonOptionSet.TsaileBatchTo);
			await LoadItem();
			if (item == null)
			{
				_notFoundMsg = "Ticket not found";
				StateHasChanged();
				return;
			}
			_userId = UserContext.UserProfile.Id;
			if (item.IsLocked)
			{
				string msg;
				if (item?.LockedById == _userId)
				{
					msg = $"You have this ticket open in another session";
				}
				else
				{
					msg = $"Ticket is locked by {item?.LockedBy?.DisplayName}";
				}
				Notifications.Notify(detail: msg);
				Nav.NavigateToRelative(fromParent: true);
				return;
			}
			await item.LockAsync(DbFactory, _userId);
			_unlockSubscription = UnlockService.Subscribe(Id, OnUnlockMessageAsync);
			_lockedByMe = true;
			StateHasChanged();
		}
	}
	private async Task SaveAndSubmit()
	{
		await item.AdvanceStatusAndSaveAsync(DbFactory, _userId);
		Notifications.Success("Successfully saved ticket");
		Nav.NavigateToRelative(fromParent: true);
	}

	private async Task SaveAttributes(TsaileBetterq dialogData)
	{
		if (dialogData != null)
		{
			await DbFactory.UpdateItemAsync<TsaileBetterq>(dialogData);
			Notifications.Success("Successfully saved attributes");
		}
		await LoadItem();
		StateHasChanged();
	}

	private async Task LoadItem()
	{
		await using var db = await DbFactory.CreateDbContextAsync();
		item = await db.TsaileBetterqs
				.Include(x => x.Patient)
				.Include(x => x.LockedBy)
				.FirstOrDefaultAsync(x => x.Id == Id);
	}

	private async Task LoadAndStateHasChanged()
	{
		await LoadItem();
		StateHasChanged();
	}

	private IQueryable<CommentModel> CommentQueryFactory(mainContext db) =>
		db.TsaileComments
				.Where(x => x.TsaileBetterqId == Id)
				.Include(x => x.AuthUser)
				.OrderBy(x => x.CreatedAt)
				.Select(x => new CommentModel
		  {
			  Id = x.Id,
			  AuthUser = x.AuthUser,
			  CreatedAt = x.CreatedAt,
			  Text = x.Remarks
		  });

	private TsaileComment MapComment(CommentModel m) => new TsaileComment
	{
		Id = (int)m.Id,
		TsaileBetterqId = Id,
		Remarks = m.Text,
		CreatedAt = m.CreatedAt,
		AuthUserId = m.AuthUser.Id
	};
	private IQueryable<CommentModel> CommentQueryFactoryPatient(mainContext db) =>
		db.TsailePatientcomments
				.Where(x => x.PatientId == item.PatientId)
				.Include(x => x.AuthUser)
				.OrderBy(x => x.CreatedAt)
				.Select(x => new CommentModel
		  {
			  Id = x.Id,
			  AuthUser = x.AuthUser,
			  CreatedAt = x.CreatedAt,
			  Text = x.Comment
		  });

	private TsailePatientcomment MapCommentPatient(CommentModel m) => new TsailePatientcomment
	{
		Id = m.Id,
		PatientId = item.PatientId,
		Comment = m.Text,
		CreatedAt = m.CreatedAt,
		AuthUserId = m.AuthUser.Id
	};

	private async Task OnFillDateChange(DateOnly? newDate, TsaileBetterq row)
	{
		if (newDate == null || newDate <= DateOnly.FromDateTime(DateTime.Now)) return;

	}

	IEnumerable<SplitButtonItem> BuildButtons() => new[]
	{
		new SplitButtonItem
		{
			Text = $"Move to {item?.NextStatusEnum.ToString()}",
			Value = "Submit",
			Icon = "arrow_forward",
			IconColor = Colors.Success,
			Disabled = () => item?.Status == TsaileTicketStatus.Complete.ToString(),
			Action = async () =>
			{
				await item?.AdvanceStatusAndSaveAsync(DbFactory, _userId);
				Notifications.Success($"Status updated to {item?.Status}");
				Nav.NavigateToRelative(fromParent: true);
			}
		},
		new SplitButtonItem
		{
			Text = $"Move to {item?.PreviousStatusEnum.ToString()}",
			Value = "Back",
			Icon = "arrow_back",
			IconColor = Colors.WarningLight,
			Disabled = () => item?.Status == TsaileTicketStatus.Screening.ToString(),
			Action = async () =>
			{
				await item?.ReverseStatusAndSaveAsync(DbFactory, _userId);
				await LoadItem();
				Notifications.Success($"Status updated to {item?.Status}");
				StateHasChanged();
			}
		},
		new SplitButtonItem
		{
			Text = "Change Status",
			Value = "ChangeStatus",
			Icon = "edit",
			IconColor = Colors.Info,
			Action = async () =>
			{
				string newStatus = await DialogService.ListDialogAsync(Enum.GetNames<TsaileTicketStatus>().ToHashSet());
				if (newStatus == null) return;
				await item?.UpdateStatusAsync(DbFactory, newStatus, _userId);
				await LoadItem();
				Notifications.Success($"Status updated to {item?.Status}");
				StateHasChanged();
			}
		},
		new SplitButtonItem
		{
			Text = "Delete Record",
			Value = "Delete",
			Icon = "delete",
			IconColor = Colors.Danger,
			Action = async () =>
			{
				var confirm = await DialogService.DeleteConfirm("Ticket");
				if (confirm == true)
				{
					await item?.UpdateStatusAsync(DbFactory, TsaileTicketStatus.Deleted.ToString(), _userId);
					Notifications.Success($"Sent to Deleted table (admin can permanently delete from there)");
					Nav.NavigateToRelative(fromParent: true);
				}
			}
		}
	};

	private async Task OnUnlockMessageAsync(UnlockMessage msg)
	{
		// Prove we are alive immediately (so requester doesn't force-unlock instantly)
		UnlockService.Ack(msg.RecordId);

		// Avoid stacking prompts
		if (_promptOpen)
			return;

		_promptOpen = true;

		try
		{
			await InvokeAsync(async () =>
			{
				var dialogTask = DialogService.YesNoDialog(
					$"{msg.RequestedByDisplayName} is requesting to unlock this ticket.\n\n" +
					"If you do nothing, it will auto-unlock in 10 seconds.",
					"Unlock Request",
					"Confirm", "Deny");
				var timeoutTask = Task.Delay(TimeSpan.FromSeconds(10));

				var winner = await Task.WhenAny(dialogTask, timeoutTask);

				bool unlockConfirmed;
				if (winner == timeoutTask)
				{
					unlockConfirmed = true; // auto-unlock
											// If your dialog service supports closing, close it here (optional)
											// DialogService.Close(true);  // example if using Radzen DialogService directly
				}
				else
				{
					var confirmed = await dialogTask; // already completed
					unlockConfirmed = confirmed == true;
				}

				UnlockService.Respond(msg.RecordId, unlockConfirmed);

				if (unlockConfirmed)
				{
					// Leave edit page. Your DisposeAsync will try to unlock if still locked by you.
					Nav.NavigateToRelative(fromParent: true);
				}
			});
		}
		finally
		{
			_promptOpen = false;
		}
	}

	public async ValueTask DisposeAsync()
	{
		try
		{
			_unlockSubscription?.Dispose();
		}
		catch { }

		if (!_lockedByMe || Id <= 0 || _userId <= 0)
			return;

		try
		{
			await using var db = await DbFactory.CreateDbContextAsync();
			var entity = await db.TsaileBetterqs.FirstOrDefaultAsync(x => x.Id == Id);
			if (entity == null)
				return;

			if (entity.LockedById == _userId)
			{
				entity.LockedById = null;
				entity.LockedDateTime = null;
				await db.SaveChangesAsync();
			}
		}
		catch
		{
			// swallow or log; don't throw from Dispose
		}
	}

}

